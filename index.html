<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aniran | Ø¬Ø³ØªØ¬ÙˆÚ¯Ø± Ø§Ù†ÛŒÙ…Ù‡ Ù‡ÙˆØ´Ù…Ù†Ø¯</title>
    
    <link rel="icon" href="/logo.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: #0A0E17;
            --bg-secondary: #121826;
            --bg-tertiary: #1A2233;
            --text-primary: #EAEFFB;
            --text-secondary: #939CB0;
            --border-color: #2A334A;
            --accent-primary: #38BDF8; /* Sky Blue */
            --accent-secondary: #E879F9; /* Fuchsia */
            --font-family: 'Vazirmatn', sans-serif;
        }

        body.light {
            --bg-primary: #FFFFFF;
            --bg-secondary: #F7F9FC;
            --bg-tertiary: #EDF1F7;
            --text-primary: #121826;
            --text-secondary: #5C677D;
            --border-color: #DDE3EE;
            --accent-primary: #0284C7; /* Darker Sky Blue */
            --accent-secondary: #C026D3; /* Darker Fuchsia */
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font-family);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .bg-primary { background-color: var(--bg-primary); }
        .bg-secondary { background-color: var(--bg-secondary); }
        .bg-tertiary { background-color: var(--bg-tertiary); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .border-color { border-color: var(--border-color); }
        .accent-primary-text { color: var(--accent-primary); }
        .accent-primary-bg { background-color: var(--accent-primary); }
        .accent-secondary-text { color: var(--accent-secondary); }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }

        .loader {
            border: 4px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .page-enter-active { animation: page-in 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .page-exit-active { animation: page-out 0.4s cubic-bezier(0.7, 0, 0.84, 0) forwards; }
        @keyframes page-in { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes page-out { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(15px); } }

        .result-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        }
        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px -10px color-mix(in srgb, var(--accent-primary) 20%, transparent);
            border-color: var(--accent-primary);
        }
        .result-card .card-img-container {
            position: relative;
            overflow: hidden;
        }
        .result-card:hover .card-img {
            transform: scale(1.05);
        }
        .card-img {
            transition: transform 0.4s ease;
        }

        @keyframes animate-gradient { to { background-position: 200% center; } }

        .animated-gradient-text {
            background-image: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary), var(--accent-primary));
            background-size: 200% auto;
            color: transparent;
            background-clip: text;
            -webkit-background-clip: text;
            animation: animate-gradient 4s linear infinite;
        }
        
        .animated-gradient-svg .gradient-path {
            fill: url(#brand-gradient);
        }
        .animated-gradient-svg .gradient-stroke {
            stroke: url(#brand-gradient);
        }
        
        .gemini-button {
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .gemini-button:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 0 20px color-mix(in srgb, var(--accent-primary) 30%, transparent), 0 0 20px color-mix(in srgb, var(--accent-secondary) 30%, transparent);
        }
        .gemini-button:disabled {
            background: var(--bg-tertiary);
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .chat-bubble {
            max-width: 75%;
            padding: 10px 15px;
            border-radius: 20px;
        }
        .chat-bubble-user {
            background-color: var(--accent-primary);
            color: white;
            border-bottom-right-radius: 5px;
            align-self: flex-end;
        }
        .chat-bubble-bot {
            background-color: var(--bg-tertiary);
            border-bottom-left-radius: 5px;
            align-self: flex-start;
        }
        
        .tab-nav-button {
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        .tab-nav-button:hover {
            color: var(--text-primary);
        }
        .tab-nav-button.active {
            color: var(--accent-primary);
            border-color: var(--accent-primary);
        }
        .tab-content {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .icon-button {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }
        .icon-button:hover {
            color: var(--accent-primary);
            border-color: var(--accent-primary);
            transform: scale(1.05);
        }
        .icon-button svg {
            transition: transform 0.3s ease;
        }
        .icon-button:hover svg {
            transform: rotate(90deg);
        }

    </style>
</head>
<body class="bg-primary text-primary">

    <header class="sticky top-0 z-30 w-full p-4 bg-primary/80 backdrop-blur-lg border-b border-color">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-1">
                <svg class="h-14 w-auto animated-gradient-svg" viewBox="0 0 80 60" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="brand-gradient" x1="-20%" y1="0%" x2="120%" y2="0%">
                             <stop offset="0%" stop-color="var(--accent-primary)"/>
                             <stop offset="50%" stop-color="var(--accent-secondary)"/>
                             <stop offset="100%" stop-color="var(--accent-primary)"/>
                             <animate attributeName="x1" from="-100%" to="100%" dur="4s" repeatCount="indefinite" />
                             <animate attributeName="x2" from="0%" to="200%" dur="4s" repeatCount="indefinite" />
                        </linearGradient>
                    </defs>
                    <g>
                        <path class="gradient-path" d="M54,55 L42,12 C41.5,10.6 39.5,10.6 39,12 L27,55 L18,55 L35,8 L46,8 L63,55 Z" />
                        <g transform="translate(4,0)">
                          <circle class="gradient-stroke" cx="56" cy="34" r="14" fill="none" stroke-width="4"/>
                          <circle class="gradient-path" cx="56" cy="34" r="6" />
                        </g>
                        <path class="gradient-path" d="M62,13 L68,3 L74,13 Z" />
                    </g>
                </svg>
                <h1 class="animated-gradient-text text-4xl font-extrabold transform translate-y-2">Aniran</h1>
            </div>
            
            <div class="relative">
                <button id="menu-toggle-btn" class="p-2 rounded-full hover:bg-secondary transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
                <div id="main-menu" class="hidden absolute left-0 mt-2 w-56 bg-secondary rounded-lg shadow-lg border border-color p-2 z-40">
                    <div class="p-2 space-y-1">
                        <button data-tab="search" class="tab-button w-full flex items-center gap-3 text-sm px-3 py-2 rounded-md hover:bg-tertiary transition-colors accent-primary-text">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                            <span>Ø¬Ø³ØªØ¬Ùˆ</span>
                        </button>
                        <button data-tab="airing" class="tab-button w-full flex items-center gap-3 text-sm px-3 py-2 rounded-md hover:bg-tertiary transition-colors text-secondary">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                            <span>Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø®Ø´</span>
                        </button>
                        <button data-tab="top" class="tab-button w-full flex items-center gap-3 text-sm px-3 py-2 rounded-md hover:bg-tertiary transition-colors text-secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                            <span>Ø¨Ø±ØªØ±ÛŒÙ†â€ŒÙ‡Ø§ÛŒ MAL</span>
                        </button>
                        <button id="telegram-bot-btn" class="w-full flex items-center gap-3 text-sm px-3 py-2 rounded-md hover:bg-tertiary transition-colors text-secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 0010 16.57l5.621.803a1 1 0 001.169-1.409l-7-14z"></path></svg>
                            <span>ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø±Ø¨Ø§Øª</span>
                        </button>
                        <hr class="border-color !my-2">
                        <div class="flex justify-between items-center px-3 py-2">
                            <span class="text-sm flex items-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" /></svg>
                                Ø­Ø§Ù„Øª Ø´Ø¨/Ø±ÙˆØ²
                            </span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="theme-switch" class="sr-only peer">
                                <div class="w-11 h-6 bg-tertiary rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-accent-primary"></div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-6">
        <div id="search-page">
            <div class="text-center my-8 md:my-16">
                <h2 class="text-4xl md:text-6xl font-extrabold animated-gradient-text mb-4">Ø¯Ù†ÛŒØ§ÛŒ Ø§Ù†ÛŒÙ…Ù‡ Ø±Ø§ Ú©Ø§ÙˆØ´ Ú©Ù†ÛŒØ¯</h2>
                <p class="text-lg text-secondary max-w-2xl mx-auto">Ù‡Ø± Ø§Ù†ÛŒÙ…Ù‡â€ŒØ§ÛŒ Ú©Ù‡ Ø¨Ù‡ Ø¯Ù†Ø¨Ø§Ù„Ø´ Ù‡Ø³ØªÛŒØ¯ Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ù†ÛŒØ¯ØŒ Ø§Ø² Ø¢Ø«Ø§Ø± Ú©Ù„Ø§Ø³ÛŒÚ© ØªØ§ Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø¹Ù†Ø§ÙˆÛŒÙ† Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø®Ø´.</p>
            </div>
            <form id="search-form" class="max-w-2xl mx-auto">
                <div class="relative">
                    <input type="search" id="search-input" class="bg-secondary w-full p-4 pr-12 text-lg rounded-full border-2 border-color focus:border-accent-primary focus:outline-none focus:ring-2 focus:ring-accent-primary/50 transition-all placeholder-text-secondary" placeholder="Ù†Ø§Ù… Ø§Ù†ÛŒÙ…Ù‡ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ ÛŒØ§ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ..." required>
                    <svg class="w-6 h-6 absolute top-1/2 -translate-y-1/2 right-4 text-secondary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
            </form>
            <div class="text-center mt-6">
                <button id="smart-suggest-btn" class="gemini-button text-white font-bold py-3 px-6 rounded-full">
                    âœ¨ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…ÙÙ‡ÙˆÙ…ÛŒ
                </button>
            </div>
        </div>

        <div id="list-page" class="hidden">
            <h2 id="list-title" class="text-3xl font-bold text-center my-8"></h2>
            <div id="season-nav" class="hidden justify-center items-center gap-4 my-6">
                <button id="prev-season-btn" class="accent-primary-bg text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 transition-opacity">< ÙØµÙ„ Ù‚Ø¨Ù„</button>
                <span id="season-display" class="font-bold text-xl"></span>
                <button id="next-season-btn" class="accent-primary-bg text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 transition-opacity">ÙØµÙ„ Ø¨Ø¹Ø¯ ></button>
            </div>
        </div>
        
        <h3 id="smart-results-title" class="text-2xl font-bold text-center my-8 hidden"></h3>

        <div id="loader" class="hidden justify-center items-center my-16 flex-col"><div class="loader"></div></div>
        <div id="message" class="text-center text-secondary my-8 text-lg"></div>
        <div id="results-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 md:gap-6 mt-12"></div>
        <div id="show-more-container" class="text-center mt-8"></div>
    </main>

    <section id="details-page" class="hidden"></section>
    
    <div id="modal-container"></div>

    <footer class="text-center py-8 mt-12 border-t border-color">
        <p class="text-secondary text-sm mb-4">
            ØªÙˆØ³Ø¹Ù‡ Ø¯Ù‡Ù†Ø¯Ù‡ : Abolfazl_ASDBV
        </p>
        <div class="flex justify-center gap-6">
            <a href="https://t.me/anime_sub_Persian" target="_blank" rel="noopener noreferrer" title="Telegram"
               class="text-secondary hover:accent-primary-text transition-colors">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" role="img" aria-label="Telegram icon">
                    <path d="M11.999 0C5.372 0 0 5.373 0 12s5.372 12 11.999 12C18.626 24 24 18.627 24 12S18.626 0 11.999 0zM18.26 8.13l-2.73 12.04c-.15.66-.54 1.25-1.1 1.25-.3 0-.58-.12-.82-.36l-3.37-3.11-1.63 1.57c-.18.17-.4.29-.63.29-.3 0-.58-.12-.8-.34l-.45-.43c-.4-.38-.63-1.12-.2-1.6l2.9-4.3 6.03-5.52c.26-.24.06-.39-.22-.25l-7.3 4.54-3.5-1.09c-.6-.18-.9-.45-.9-.94 0-.4.2-.68.6-.85l14.28-5.57c.5-.2 1.02.1 1.2.63z"/>
                </svg>
            </a>
            <a href="https://www.instagram.com/anime_wd20?igsh=dTA1dmNsYjhzcGx1" target="_blank" rel="noopener noreferrer" title="Instagram"
               class="text-secondary hover:accent-secondary-text transition-colors">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" role="img" aria-label="Instagram icon">
                    <path d="M12 0C8.74 0 8.333.015 7.053.072 5.775.132 4.905.333 4.14.63c-.784.297-1.459.717-2.126 1.384S.927 3.356.63 4.14C.333 4.905.131 5.775.072 7.053.012 8.333 0 8.74 0 12s.015 3.667.072 4.947c.06 1.277.261 2.148.558 2.913.297.784.717 1.459 1.384 2.126.667.666 1.342 1.086 2.126 1.384.766.296 1.636.499 2.913.558C8.333 23.988 8.74 24 12 24s3.667-.015 4.947-.072c1.277-.06 2.148-.262 2.913-.558.784-.297 1.459-.718 2.126-1.384.666-.667 1.086-1.342 1.384-2.126.296-.765.499-1.636.558-2.913.06-1.277.072-1.687.072-4.947s-.015-3.667-.072-4.947c-.06-1.277-.262-2.148-.558-2.913-.297-.784-.718-1.459-1.384-2.126C20.644.927 19.969.507 19.185.21c-.765-.297-1.636-.499-2.913-.558C15.667.012 15.26 0 12 0zm0 2.163c3.203 0 3.585.012 4.85.07 1.17.055 1.805.249 2.227.415.562.217.96.477 1.382.896.419.42.679.819.896 1.381.164.422.36 1.057.413 2.227.057 1.265.07 1.646.07 4.85s-.012 3.585-.07 4.85c-.055 1.17-.249 1.805-.413 2.227-.217.562-.477.96-.896 1.382-.42.419-.819.679-1.381.896-.422.164-1.057.36-2.227.413-1.265.057-1.646.07-4.85.07s-3.585-.012-4.85-.07c-1.17-.055-1.805-.249-2.227-.413-.562-.217-.96-.477-1.382-.896-.419-.42-.679-.819-.896-1.381-.164-.422-.36-1.057-.413-2.227-.057-1.265-.07-1.646-.07-4.85s.012-3.585.07-4.85c.055-1.17.249 1.805.413 2.227.217.562.477.96.896-1.382.42-.419.819.679 1.381.896.422.164 1.057.36 2.227.413 1.265.057 1.646.07 4.85.07zM12 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.88 1.44 1.44 0 000-2.88z"/>
                </svg>
            </a>
        </div>
    </footer>
    <script type="module">
        const DOMElements = {
            mainPage: document.querySelector('main'),
            searchPage: document.getElementById('search-page'),
            listPage: document.getElementById('list-page'),
            listTitle: document.getElementById('list-title'),
            detailsPage: document.getElementById('details-page'),
            searchForm: document.getElementById('search-form'),
            searchInput: document.getElementById('search-input'),
            resultsContainer: document.getElementById('results-container'),
            showMoreContainer: document.getElementById('show-more-container'),
            smartResultsTitle: document.getElementById('smart-results-title'),
            messageDiv: document.getElementById('message'),
            loader: document.getElementById('loader'),
            themeSwitch: document.getElementById('theme-switch'),
            modalContainer: document.getElementById('modal-container'),
            seasonNav: document.getElementById('season-nav'),
            seasonDisplay: document.getElementById('season-display'),
            prevSeasonBtn: document.getElementById('prev-season-btn'),
            nextSeasonBtn: document.getElementById('next-season-btn'),
            smartSuggestBtn: document.getElementById('smart-suggest-btn'),
            menuToggleBtn: document.getElementById('menu-toggle-btn'),
            mainMenu: document.getElementById('main-menu'),
        };

        let isTransitioning = false;
        let currentSeasonState = { year: 0, season: '' };
        let searchDebounceTimeout;
        let latestSearchQuery = '';
        let currentAnimeData = null;
        let currentPage = 1;
        let currentListType = '';

        const delay = ms => new Promise(resolve => setTimeout(resolve, ms));
        
        function proxyImageUrl(url) {
            const placeholder = 'https://placehold.co/400x600/1A2233/939CB0?text=Ø¨Ø¯ÙˆÙ†+Ø¹Ú©Ø³';
            if (!url) {
                return placeholder;
            }
            if (url.includes('placehold.co')) {
                return url;
            }
            return `/.netlify/functions/image-proxy?url=${encodeURIComponent(url)}`;
        }

        const offlineTranslator = {
            dictionary: {
                "Action": "Ø§Ú©Ø´Ù†", "Adventure": "Ù…Ø§Ø¬Ø±Ø§Ø¬ÙˆÛŒÛŒ", "Comedy": "Ú©Ù…Ø¯ÛŒ", "Drama": "Ø¯Ø±Ø§Ù…", "Fantasy": "ÙØ§Ù†ØªØ²ÛŒ", "Urban Fantasy": "ÙØ§Ù†ØªØ²ÛŒ Ø´Ù‡Ø±ÛŒ", "Horror": "ØªØ±Ø³Ù†Ø§Ú©", "Mystery": "Ø±Ø§Ø²Ø¢Ù„ÙˆØ¯", "Romance": "Ø¹Ø§Ø´Ù‚Ø§Ù†Ù‡", "Sci-Fi": "Ø¹Ù„Ù…ÛŒ ØªØ®ÛŒÙ„ÛŒ", "Slice of Life": "Ø¨Ø±Ø´ÛŒ Ø§Ø² Ø²Ù†Ø¯Ú¯ÛŒ", "Sports": "ÙˆØ±Ø²Ø´ÛŒ", "Supernatural": "Ù…Ø§ÙˆØ±Ø§Ø¡ Ø·Ø¨ÛŒØ¹ÛŒ", "Suspense": "Ø¯Ù„Ù‡Ø±Ù‡ Ø¢ÙˆØ±", "Award Winning": "Ø¨Ø±Ù†Ø¯Ù‡ Ø¬Ø§ÛŒØ²Ù‡",
                "Gourmet": "Ø®ÙˆØ´ Ø®ÙˆØ±Ø§Ú©", "Ecchi": "Ø§ÛŒÚ†ÛŒ", "Erotica": "Ø§Ø±ÙˆØªÛŒÚ©", "Hentai": "Ù‡Ù†ØªØ§ÛŒ", "Adult Cast": "Ø¨Ø§Ø²ÛŒÚ¯Ø±Ø§Ù† Ø¨Ø²Ø±Ú¯Ø³Ø§Ù„", "Anthropomorphic": "Ø§Ù†Ø³Ø§Ù†â€ŒØ§Ù†Ú¯Ø§Ø±ÛŒ", "CGDCT": "Ø¯Ø®ØªØ±Ø§Ù† Ù†Ø§Ø² Ú©Ø§Ø±Ù‡Ø§ÛŒ Ù†Ø§Ø² Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ¯Ù‡Ù†Ø¯", "Childcare": "Ù…Ø±Ø§Ù‚Ø¨Øª Ø§Ø² Ú©ÙˆØ¯Ú©", "Combat Sports": "ÙˆØ±Ø²Ø´â€ŒÙ‡Ø§ÛŒ Ø±Ø²Ù…ÛŒ", "Crossdressing": "Ù…Ø¨Ø¯Ù„â€ŒÙ¾ÙˆØ´ÛŒ", "Delinquents": "Ø¨Ø²Ù‡Ú©Ø§Ø±Ø§Ù†", "Detective": "Ú©Ø§Ø±Ø¢Ú¯Ø§Ù‡ÛŒ", "Educational": "Ø¢Ù…ÙˆØ²Ø´ÛŒ", "Gag Humor": "Ø·Ù†Ø² Ø¨ÛŒâ€ŒÙ…Ø¹Ù†ÛŒ", "Gore": "Ø®ÙˆÙ†ÛŒÙ†", "Harem": "Ø­Ø±Ù…Ø³Ø±Ø§", "High Stakes Game": "Ø¨Ø§Ø²ÛŒ Ù¾Ø±Ø®Ø·Ø±", "Historical": "ØªØ§Ø±ÛŒØ®ÛŒ", "Idols (Female)": "Ø¢ÛŒØ¯Ù„ (Ø²Ù†)", "Idols (Male)": "Ø¢ÛŒØ¯Ù„ (Ù…Ø±Ø¯)", "Isekai": "Ø§ÛŒØ³Ú©Ø§ÛŒ", "Iyashikei": "Ø¢Ø±Ø§Ù…Ø´â€ŒØ¨Ø®Ø´", "Love Polygon": "Ú†Ù†Ø¯Ø¶Ù„Ø¹ÛŒ Ø¹Ø´Ù‚ÛŒ", "Magical Sex-Shift": "ØªØºÛŒÛŒØ± Ø¬Ù†Ø³ÛŒØª Ø¬Ø§Ø¯ÙˆÛŒÛŒ", "Mahou Shoujo": "Ø¯Ø®ØªØ± Ø¬Ø§Ø¯ÙˆÛŒÛŒ", "Martial Arts": "Ù‡Ù†Ø±Ù‡Ø§ÛŒ Ø±Ø²Ù…ÛŒ", "Mecha": "Ù…Ú©Ø§", "Medical": "Ù¾Ø²Ø´Ú©ÛŒ", "Military": "Ù†Ø¸Ø§Ù…ÛŒ", "Music": "Ù…ÙˆØ³ÛŒÙ‚ÛŒ", "Mythology": "Ø§Ø³Ø§Ø·ÛŒØ±ÛŒ", "Organized Crime": "Ø¬Ø±Ø§ÛŒÙ… Ø³Ø§Ø²Ù…Ø§Ù†â€ŒÛŒØ§ÙØªÙ‡", "Otaku Culture": "ÙØ±Ù‡Ù†Ú¯ Ø§ÙˆØªØ§Ú©Ùˆ", "Parody": "Ù†Ù‚ÛŒØ¶Ù‡", "Performing Arts": "Ù‡Ù†Ø±Ù‡Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ÛŒ", "Pets": "Ø­ÛŒÙˆØ§Ù†Ø§Øª Ø®Ø§Ù†Ú¯ÛŒ", "Psychological": "Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø®ØªÛŒ", "Racing": "Ù…Ø³Ø§Ø¨Ù‚Ù‡â€ŒØ§ÛŒ", "Reincarnation": "ØªÙ†Ø§Ø³Ø®", "Reverse Harem": "Ø­Ø±Ù…Ø³Ø±Ø§ÛŒ Ù…Ø¹Ú©ÙˆØ³", "Romantic Subtext": "Ù…Ø¹Ù†Ø§ÛŒ Ø¶Ù…Ù†ÛŒ Ø¹Ø§Ø´Ù‚Ø§Ù†Ù‡", "Samurai": "Ø³Ø§Ù…ÙˆØ±Ø§ÛŒÛŒ", "School": "Ù…Ø¯Ø±Ø³Ù‡â€ŒØ§ÛŒ", "Showbiz": "Ø´ÙˆØ¨ÛŒØ²", "Space": "ÙØ¶Ø§ÛŒÛŒ", "Strategy Game": "Ø¨Ø§Ø²ÛŒ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒÚ©", "Super Power": "Ù‚Ø¯Ø±Øª ÙÙˆÙ‚â€ŒØ§Ù„Ø¹Ø§Ø¯Ù‡", "Survival": "Ø¨Ù‚Ø§", "Team Sports": "ÙˆØ±Ø²Ø´ ØªÛŒÙ…ÛŒ", "Time Travel": "Ø³ÙØ± Ø¯Ø± Ø²Ù…Ø§Ù†", "Vampire": "Ø®ÙˆÙ†â€ŒØ¢Ø´Ø§Ù…", "Video Game": "Ø¨Ø§Ø²ÛŒ ÙˆÛŒØ¯ÛŒÙˆÛŒÛŒ", "Visual Arts": "Ù‡Ù†Ø±Ù‡Ø§ÛŒ ØªØ¬Ø³Ù…ÛŒ", "Workplace": "Ù…Ø­ÛŒØ· Ú©Ø§Ø±", "Avant Garde": "Ø¢ÙˆØ§Ù†Ú¯Ø§Ø±Ø¯",
                "Josei": "Ø¬ÙˆØ³ÙÛŒ", "Kids": "Ú©ÙˆØ¯Ú©Ø§Ù†", "Seinen": "Ø³ÛŒÙ†Ù†", "Shoujo": "Ø´ÙˆØ¬Ùˆ", "Shounen": "Ø´ÙˆÙ†Ù†", "Boys Love": "Ø¹Ø´Ù‚ Ù¾Ø³Ø±Ø§Ù†", "Girls Love": "Ø¹Ø´Ù‚ Ø¯Ø®ØªØ±Ø§Ù†",
                "Currently Airing": "Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø®Ø´", "Finished Airing": "Ù¾Ø®Ø´ ØªÙ…Ø§Ù… Ø´Ø¯Ù‡", "Not yet aired": "Ù‡Ù†ÙˆØ² Ù¾Ø®Ø´ Ù†Ø´Ø¯Ù‡",
                "TV": "ØªÙ„ÙˆÛŒØ²ÛŒÙˆÙ†ÛŒ", "Movie": "Ø³ÛŒÙ†Ù…Ø§ÛŒÛŒ", "OVA": "Ø§Ùˆ ÙˆÛŒ Ø§ÛŒ", "Special": "ÙˆÛŒÚ˜Ù‡", "ONA": "Ø§Ùˆ Ø§Ù† Ø§ÛŒ", 
                "winter": "Ø²Ù…Ø³ØªØ§Ù†", "spring": "Ø¨Ù‡Ø§Ø±", "summer": "ØªØ§Ø¨Ø³ØªØ§Ù†", "fall": "Ù¾Ø§ÛŒÛŒØ²",
                "G - All Ages": "G - Ø¨Ø±Ø§ÛŒ ØªÙ…Ø§Ù… Ø³Ù†ÛŒÙ†", "PG - Children": "PG - Ø¨Ø±Ø§ÛŒ Ú©ÙˆØ¯Ú©Ø§Ù†", "PG-13 - Teens 13 or older": "PG-13 - Ø¨Ø±Ø§ÛŒ Ù†ÙˆØ¬ÙˆØ§Ù†Ø§Ù† Û±Û³ Ø³Ø§Ù„ Ø¨Ù‡ Ø¨Ø§Ù„Ø§", "R - 17+ (violence & profanity)": "R - 17+ (Ø®Ø´ÙˆÙ†Øª Ùˆ Ù†Ø§Ø³Ø²Ø§)", "R+ - Mild Nudity": "R+ - Ø¨Ø±Ù‡Ù†Ú¯ÛŒ Ø®ÙÛŒÙ", "Rx - Hentai": "Rx - Ù‡Ù†ØªØ§ÛŒ",
                "Manga": "Ù…Ø§Ù†Ú¯Ø§", "Original": "Ø§ÙˆØ±Ø¬ÛŒÙ†Ø§Ù„", "Light novel": "Ù„Ø§ÛŒØª Ù†Ø§ÙˆÙ„", "Game": "Ø¨Ø§Ø²ÛŒ", "Visual novel": "ÙˆÛŒÚ˜ÙˆØ§Ù„ Ù†Ø§ÙˆÙ„", "Web manga": "ÙˆØ¨ Ù…Ø§Ù†Ú¯Ø§", "Novel": "Ø±Ù…Ø§Ù†", "4-koma manga": "Ù…Ø§Ù†Ú¯Ø§ Û´ Ù¾Ù†Ù„ÛŒ", "Book": "Ú©ØªØ§Ø¨", "Picture book": "Ú©ØªØ§Ø¨ Ù…ØµÙˆØ±", "Card game": "Ø¨Ø§Ø²ÛŒ Ú©Ø§Ø±ØªÛŒ", "Web novel": "ÙˆØ¨ Ù†Ø§ÙˆÙ„", "Other": "ØºÛŒØ±Ù‡", "Music": "Ù…ÙˆØ³ÛŒÙ‚ÛŒ", "Radio": "Ø±Ø§Ø¯ÛŒÙˆ",
            },
            translate(text) {
                if (!text) return text;
                const trimmedText = text.trim();
                if (this.dictionary[trimmedText]) {
                    return this.dictionary[trimmedText];
                }
                const cleanText = trimmedText.replace(/\s*\([^)]*\)$/, '').replace(/\[Written by MAL Rewrite\]/g, '').trim();
                return this.dictionary[cleanText] || text;
            }
        };

        const APIManager = {
            async fetchJikan(endpoint, forceRefresh = false) {
                try {
                    let apiUrl = '';
                    
                    const detailMatch = endpoint.match(/^anime\/(\d+)\/full$/);
                    if (detailMatch && detailMatch[1]) {
                        apiUrl = `/.netlify/functions/get-anime-details?id=${detailMatch[1]}`;
                        if (forceRefresh) {
                            apiUrl += '&refresh=true';
                        }
                    } else {
                        apiUrl = `/.netlify/functions/jikan-proxy?endpoint=${encodeURIComponent(endpoint)}`;
                    }

                    const response = await fetch(apiUrl);
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        const errorMessage = errorData.message || errorData.error || response.statusText;
                        // --- *** Ø§ØµÙ„Ø§Ø­: Ù¾Ø±ØªØ§Ø¨ Ú©Ø±Ø¯Ù† Ø®Ø·Ø§ÛŒ 404/500 *** ---
                        // Ø§ÛŒÙ† Ø®Ø·Ø§ Ø¯Ø± catch Ø¨Ù„Ø§Ú©Ù UIManager.showDetailsPage Ù…Ø¯ÛŒØ±ÛŒØª Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯
                        throw new Error(`Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± (${response.status}): Jikan API error: ${errorMessage}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error("API proxy error:", error);
                    // Ø®Ø·Ø§ÛŒ ØªØ±Ø¬Ù…Ù‡ Ù†Ø§Ù…ÙˆÙÙ‚ Ø§Ø² Ø¨Ú©â€ŒØ§Ù†Ø¯ (Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯)
                    if (error.message.includes("Translation failed")) {
                        throw new Error("ØªØ±Ø¬Ù…Ù‡ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯. Ù„Ø·ÙØ§Ù‹ Ù„Ø§Ú¯ Netlify Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.");
                    }
                    // Ø®Ø·Ø§ÛŒ Jikan (404/500)
                    if (error.message.includes("Jikan API error")) {
                        throw error; // Ø®Ø·Ø§ Ø±Ø§ Ø¨Ù‡ showDetailsPage Ø§Ø±Ø³Ø§Ù„ Ú©Ù†
                    }
                    throw new Error(error.message || "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª.");
                }
            },
            
            async callGemini(prompt, isJson = false) {
                try {
                    const payload = { 
                        contents: [{ role: "user", parts: [{ text: prompt }] }],
                        ...(isJson && { generationConfig: { responseMimeType: "application/json" } })
                    };
                    
                    const apiUrl = `/.netlify/functions/gemini-proxy`;
                    
                    const response = await fetch(apiUrl, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        if (errorData.error && errorData.error.message) {
                            if (response.status === 429 || errorData.error.message.includes("Resource Exhausted")) {
                                throw new Error("Resource Exhausted (429)");
                            }
                            throw new Error(`Ø®Ø·Ø§ Ø§Ø² Ø³Ø±ÙˆØ± Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ: ${errorData.error.message}`);
                        }
                        throw new Error(`Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ: (${response.status})`);
                    }
                    
                    const result = await response.json();
                    
                    const blockReason = result.candidates?.[0]?.finishReason === 'SAFETY' || result.promptFeedback?.blockReason;
                    if (blockReason) {
                        console.warn("Gemini response blocked:", result);
                        throw new Error("PROHIBITED_CONTENT");
                    }

                    const part = result.candidates?.[0]?.content?.parts?.[0];
                    if (part?.text) {
                        try {
                            return isJson ? JSON.parse(part.text) : part.text;
                        } catch (e) {
                            console.error("Failed to parse Gemini JSON response:", e, part.text);
                            throw new Error("Ù¾Ø§Ø³Ø® Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯Ù‡ Ø§Ø² Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¯Ø± ÙØ±Ù…Øª Ù…ÙˆØ±Ø¯ Ø§Ù†ØªØ¸Ø§Ø± (JSON) Ù†Ø¨ÙˆØ¯.");
                        }
                    } else {
                        throw new Error("Ù¾Ø§Ø³Ø® ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡ ÛŒØ§ Ø®Ø§Ù„ÛŒ Ø§Ø² Ø³Ø±ÙˆÛŒØ³ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯.");
                    }
                } catch (error) {
                    console.error("Gemini API Call Error:", error);
                    throw error;
                }
            },
            
            async translateToEnglish(text) {
                if (!text) return text;
                
                const cacheKey = `en_${text}`;
                if (sessionStorage.getItem(cacheKey)) return sessionStorage.getItem(cacheKey);

                try {
                    const prompt = `Translate the following Persian phrase to its most common English title for anime searching. Respond with only the English translation. Phrase: "${text}"`;
                    const translation = await this.callGemini(prompt);
                    const cleanedTranslation = translation.replace(/["'Â«Â»]/g, "").trim();
                    if (cleanedTranslation) sessionStorage.setItem(cacheKey, cleanedTranslation);
                    return cleanedTranslation || text;
                } catch (error) {
                    console.error("Translation Error (to English):", error);
                    throw new Error(App.getFriendlyErrorMessage(error));
                }
            }
        };

        const ModalManager = {
            create(id, content, options = {}) {
                this.closeAll();
                const modalWrapper = document.createElement('div');
                modalWrapper.id = id;
                modalWrapper.className = "fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4";
                const modalContent = document.createElement('div');
                modalContent.className = `bg-secondary rounded-lg shadow-xl w-full flex flex-col ${options.maxWidth || 'max-w-xl'} ${options.maxHeight || 'max-h-[90vh]'}`;
                modalContent.innerHTML = content;
                modalWrapper.appendChild(modalContent);
                DOMElements.modalContainer.appendChild(modalWrapper);
                return modalContent;
            },
            close(id) {
                const modal = document.getElementById(id);
                if (modal) modal.remove();
            },
            closeAll() { DOMElements.modalContainer.innerHTML = ''; },
            showNotification(message, type = 'info') {
                this.closeAll();
                const colors = {
                    info: 'accent-primary-bg',
                    success: 'bg-green-500',
                    error: 'bg-red-500'
                };
                const modalWrapper = document.createElement('div');
                modalWrapper.id = 'notification-modal';
                modalWrapper.className = "fixed top-5 right-5 z-50 transition-transform duration-300 transform translate-x-full";
                modalWrapper.innerHTML = `<div class="p-4 text-white ${colors[type] || colors.info} rounded-lg shadow-lg"><p>${message}</p></div>`;
                DOMElements.modalContainer.appendChild(modalWrapper);
                
                setTimeout(() => modalWrapper.classList.remove('translate-x-full'), 10);

                setTimeout(() => {
                    modalWrapper.classList.add('translate-x-full');
                    setTimeout(() => this.close('notification-modal'), 3000);
                }, 3000);
            }
        };

        const UIManager = {
            showLoader(show) { DOMElements.loader.style.display = show ? 'flex' : 'none'; },
            showMessage(text, isError = false) { 
                DOMElements.messageDiv.textContent = text;
                DOMElements.messageDiv.classList.toggle('text-red-400', isError);
                DOMElements.messageDiv.classList.toggle('text-secondary', !isError);
            },
            displayResults(results, title = '', options = {}) {
                if (!options.append) {
                    DOMElements.resultsContainer.innerHTML = '';
                    DOMElements.showMoreContainer.innerHTML = '';
                }
                
                DOMElements.smartResultsTitle.classList.toggle('hidden', !title);
                DOMElements.smartResultsTitle.textContent = title;

                if (!results || results.length === 0) { 
                    if (!options.append) this.showMessage("Ù‡ÛŒÚ† Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.");
                    return; 
                }
                
                results.forEach(item => {
                    const node = item.node || item;
                    const card = document.createElement('div');
                    card.className = 'result-card bg-tertiary rounded-lg overflow-hidden shadow-lg cursor-pointer group border border-transparent';
                    card.dataset.id = node.mal_id;
                    
                    card.innerHTML = `
                        <div class="card-img-container rounded-lg">
                            <img src="${proxyImageUrl(node.images.webp.large_image_url)}" alt="${node.title}" class="card-img w-full h-auto aspect-[2/3] object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x600/1A2233/939CB0?text=Ø¨Ø¯ÙˆÙ†+Ø¹Ú©Ø³';">
                            <div class="absolute bottom-0 left-0 right-0 p-3 bg-gradient-to-t from-black/80 to-transparent">
                                <h3 class="font-bold text-sm text-white truncate group-hover:accent-primary-text transition-colors" title="${node.title}">${node.title}</h3>
                                <div class="text-xs text-gray-300 flex justify-between items-center mt-1">
                                    <span>${node.type || ''}</span>
                                    <span class="flex items-center gap-1">
                                        <svg class="w-3 h-3 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                                        ${node.score || 'N/A'}
                                    </span>
                                </div>
                            </div>
                        </div>`;
                    DOMElements.resultsContainer.appendChild(card);
                });

                if (options.showMoreCallback) {
                    DOMElements.showMoreContainer.innerHTML = '';
                    const showMoreBtn = document.createElement('button');
                    showMoreBtn.id = 'show-more-btn';
                    showMoreBtn.className = 'gemini-button text-white font-bold py-3 px-6 rounded-full';
                    showMoreBtn.innerHTML = 'Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø¨ÛŒØ´ØªØ±';
                    DOMElements.showMoreContainer.appendChild(showMoreBtn);
                }
            },
            
            showMainPage() {
                if (!DOMElements.detailsPage.classList.contains('hidden')) {
                    if (isTransitioning) return; 
                    isTransitioning = true;
                    DOMElements.detailsPage.classList.add('page-exit-active');
                    ModalManager.closeAll();
                    
                    setTimeout(() => {
                        DOMElements.detailsPage.classList.add('hidden'); 
                        DOMElements.detailsPage.classList.remove('page-exit-active');
                        DOMElements.mainPage.classList.remove('hidden'); 
                        DOMElements.mainPage.classList.add('page-enter-active');
                        DOMElements.detailsPage.innerHTML = ''; 
                        isTransitioning = false;
                    }, 400);
                } else {
                    DOMElements.mainPage.classList.remove('hidden');
                }
            },
            
            async showDetailsPage(id, forceRefresh = false) {
                if (isTransitioning) return; isTransitioning = true;
                DOMElements.mainPage.classList.add('hidden');
                DOMElements.detailsPage.innerHTML = `<div class="flex justify-center items-center min-h-screen"><div class="loader"></div></div>`;
                DOMElements.detailsPage.classList.remove('hidden');
                DOMElements.detailsPage.classList.add('page-enter-active');
                window.scrollTo(0, 0);
                
                try {
                    const result = await APIManager.fetchJikan(`anime/${id}/full`, forceRefresh);
                    
                    // --- *** Ø§ØµÙ„Ø§Ø­: Ù…Ø¯ÛŒØ±ÛŒØª Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø§Ø¹Ù„Ø§Ù† ØªØ±Ø¬Ù…Ù‡ *** ---
                    if (result.translationError) {
                        if (result.translationError === 'rate_limit') {
                            ModalManager.showNotification("Ø¸Ø±ÙÛŒØª API Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ ØªÚ©Ù…ÛŒÙ„ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø¨Ø¹Ø¯Ø§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.", "error");
                        } else { // 'general_failure'
                            ModalManager.showNotification("ØªØ±Ø¬Ù…Ù‡ Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯.", "error");
                        }
                    } else if (forceRefresh && result.source === 'api-fresh') {
                        // Ø§Ú¯Ø± Ø±ÙØ±Ø´ Ø§Ø¬Ø¨Ø§Ø±ÛŒ Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯ØŒ ÛŒÚ© ØªØ§ÛŒÛŒØ¯ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡
                        ModalManager.showNotification("ØªØ±Ø¬Ù…Ù‡ Ù…Ø¬Ø¯Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.", "success");
                    }
                    // --- *** Ù¾Ø§ÛŒØ§Ù† Ø§ØµÙ„Ø§Ø­ *** ---

                    currentAnimeData = result.data;
                    const data = currentAnimeData;
                    
                    const allGenres = [...data.genres, ...data.themes, ...data.demographics];

                    DOMElements.detailsPage.innerHTML = `
                        <div class="relative">
                            <div class="absolute top-0 left-0 w-full h-[40vh] md:h-[50vh] overflow-hidden">
                                <div class="absolute inset-0 bg-gradient-to-t from-bg-primary to-bg-primary/20 z-10"></div>
                                <img src="${proxyImageUrl(data.images.webp.large_image_url)}" class="w-full h-full object-cover object-center opacity-30" alt="Backdrop">
                            </div>
                            <button id="back-button" class="fixed top-6 right-6 bg-secondary/70 backdrop-blur-sm hover:bg-tertiary font-bold p-3 rounded-full z-20 shadow-lg transition-colors">â†</button>
                            <div class="relative z-10 container mx-auto p-4 md:p-8 max-w-7xl pt-[20vh] md:pt-[25vh]">
                                <div class="flex flex-col md:flex-row md:gap-8 lg:gap-12">
                                    
                                    <div class="w-full md:w-1/3 lg:w-1/4 flex-shrink-0 text-center">
                                        <img src="${proxyImageUrl(data.images.webp.large_image_url)}" alt="Poster" class="w-full max-w-[250px] mx-auto rounded-xl shadow-2xl shadow-black/50 border-4 border-tertiary" onerror="this.onerror=null;this.src='https://placehold.co/400x600/1A2233/939CB0?text=Ø¨Ø¯ÙˆÙ†+Ø¹Ú©Ø³';">
                                        <div class="mt-4">
                                            <h2 id="persian-title" class="text-2xl lg:text-3xl font-black animated-gradient-text">${data.persian_title}</h2>
                                            <p class="text-sm text-secondary mt-1">${data.title}</p>
                                        </div>
                                        <div id="details-box" class="bg-tertiary p-4 rounded-lg text-sm mt-6 text-right"></div>
                                    </div>

                                    <div class="w-full md:w-2/3 lg:w-3/4 mt-8 md:mt-0">
                                        <div class="flex flex-wrap gap-4 mb-6">
                                            <div class="flex items-center gap-2 bg-tertiary p-2 px-4 rounded-full"><span class="font-bold text-yellow-400 text-xl">${data.score || 'N/A'}</span><span class="text-xs text-secondary">Ø§Ù…ØªÛŒØ§Ø²</span></div>
                                            <div class="flex items-center gap-2 bg-tertiary p-2 px-4 rounded-full"><span class="font-bold text-xl">#${data.rank?.toLocaleString() || 'N/A'}</span><span class="text-xs text-secondary">Ø±ØªØ¨Ù‡</span></div>
                                            <div class="flex items-center gap-2 bg-tertiary p-2 px-4 rounded-full"><span class="font-bold text-xl">${data.members?.toLocaleString() || 'N/A'}</span><span class="text-xs text-secondary">Ø¹Ø¶Ùˆ</span></div>
                                        </div>

                                        <div class="border-b border-color flex space-x-1 sm:space-x-4 overflow-x-auto mb-6">
                                            <button class="tab-nav-button whitespace-nowrap py-3 px-2 sm:px-4 font-bold active" data-tab-target="#tab-content-synopsis">Ø®Ù„Ø§ØµÙ‡ Ø¯Ø§Ø³ØªØ§Ù†</button>
                                            <button class="tab-nav-button whitespace-nowrap py-3 px-2 sm:px-4 font-bold" data-tab-target="#tab-content-characters">Ø´Ø®ØµÛŒØªâ€ŒÙ‡Ø§</button>
                                            <button class="tab-nav-button whitespace-nowrap py-3 px-2 sm:px-4 font-bold" data-tab-target="#tab-content-trailers">ØªØ±ÛŒÙ„Ø±Ù‡Ø§</button>
                                            <button class="tab-nav-button whitespace-nowrap py-3 px-2 sm:px-4 font-bold" data-tab-target="#tab-content-music">Ù…ÙˆØ³ÛŒÙ‚ÛŒâ€ŒÙ‡Ø§</button>
                                            <button class="tab-nav-button whitespace-nowrap py-3 px-2 sm:px-4 font-bold" data-tab-target="#tab-content-related">Ù…Ø±ØªØ¨Ø·</button>
                                        </div>

                                        <div id="tab-content-synopsis" class="tab-content active">
                                            <div id="latest-episode-section" class="mb-6"></div>
                                            <div class="mb-6"><h3 class="font-bold text-xl mb-3">Ú˜Ø§Ù†Ø±Ù‡Ø§</h3><div id="genre-container" class="flex flex-wrap gap-2">${allGenres.map(g => `<span class="bg-tertiary text-sm font-semibold px-3 py-1 rounded-full">${offlineTranslator.translate(g.name)}</span>`).join('')}</div></div>
                                            <div class="mb-6">
                                                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-3">
                                                    <h3 class="font-bold text-xl mb-3 sm:mb-0">Ø®Ù„Ø§ØµÙ‡ Ø¯Ø§Ø³ØªØ§Ù†</h3>
                                                    <div id="ai-actions-container" class="flex gap-2 flex-wrap">
                                                        <button id="force-refresh-btn" class="icon-button text-xs font-bold p-2 rounded-full" title="Ø§Ø¬Ø¨Ø§Ø± Ø¨Ù‡ ØªØ±Ø¬Ù…Ù‡ Ù…Ø¬Ø¯Ø¯">
                                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m-15.357-2a8.001 8.001 0 0015.357 2m0 0H15" />
                                                            </svg>
                                                        </button>
                                                        <button id="watch-order-btn" class="gemini-button text-white text-xs font-bold py-2 px-3 rounded-full hidden">ğŸ“œ ØªØ±ØªÛŒØ¨ ØªÙ…Ø§Ø´Ø§</button>
                                                        <button id="smart-analysis-btn" class="gemini-button text-white text-xs font-bold py-2 px-3 rounded-full">âœ¨ ØªØ­Ù„ÛŒÙ„ Ù‡ÙˆØ´Ù…Ù†Ø¯</button>
                                                        <button id="find-similar-btn" class="icon-button text-xs font-bold py-2 px-3 rounded-full">âœ¨ ÛŒØ§ÙØªÙ† Ù…Ø´Ø§Ø¨Ù‡</button>
                                                    </div>
                                                </div>
                                                <p id="synopsis-text" class="text-secondary text-base leading-relaxed whitespace-pre-wrap">${data.persian_synopsis}</p>
                                            </div>
                                            <div id="subtitles-section" class="mb-6"></div>
                                        </div>

                                        <div id="tab-content-characters" class="tab-content hidden"></div>
                                        <div id="tab-content-trailers" class="tab-content hidden"></div>
                                        <div id="tab-content-music" class="tab-content hidden"></div>
                                        <div id="tab-content-related" class="tab-content hidden space-y-8">
                                            <div id="relations-section"></div>
                                            <div id="recommendations-section"></div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>`;
                    
                    isTransitioning = false;
                    
                    this.renderDetailsBox(data);

                    if (data.status === 'Currently Airing') this.renderLatestEpisode(id);
                    this.renderSubtitlesSection(data);
                    this.renderWatchOrderButton(data);
                    this.renderRelations(data.relations);
                    this.renderVideos(id, data.trailer);
                    this.renderThemes(id);

                    await delay(400);
                    await this.renderCharacters(id);

                    await delay(400);
                    await this.renderRecommendations(id);

                } catch (error) {
                    // --- *** Ø§ØµÙ„Ø§Ø­: Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§ÛŒ 404/500 *** ---
                    let friendlyError = error.message;
                    if (friendlyError.includes('Jikan API error') && (friendlyError.includes('404') || friendlyError.includes('500') || friendlyError.toLowerCase().includes('not found'))) {
                        friendlyError = "Ù…ÙˆØ±Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÛŒØ§ÙØª Ù†Ø´Ø¯ (ØµÙØ­Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯).";
                    }
                    // --- *** Ù¾Ø§ÛŒØ§Ù† Ø§ØµÙ„Ø§Ø­ *** ---
                    DOMElements.detailsPage.innerHTML = `<button id="back-button" class="fixed top-6 right-6 bg-secondary/70 hover:bg-tertiary font-bold p-3 rounded-full z-20 shadow-lg">â†</button><div class="flex justify-center items-center min-h-screen"><p class="p-8 text-center text-red-400 text-xl font-bold">${friendlyError}</p></div>`;
                    isTransitioning = false;
                }
            },
            
            renderDetailsBox(data) {
                const detailsBox = document.getElementById('details-box');
                if (!detailsBox) return;
                
                const studiosHTML = data.studios.map(s => 
                    `<a href="#" class="studio-link accent-primary-text hover:underline" data-action="open-studio" data-studio-id="${s.mal_id}" data-studio-name="${s.name}">${s.name}</a>`
                ).join(', ') || 'Ù†Ø§Ù…Ø´Ø®Øµ';

                detailsBox.innerHTML = `
                    <h3 class="font-bold text-lg mb-3">Ø¬Ø²Ø¦ÛŒØ§Øª</h3>
                    <p class="mb-2"><strong>Ù†ÙˆØ¹:</strong> <span id="type-value">${offlineTranslator.translate(data.type) || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</span></p>
                    <p class="mb-2"><strong>Ù…Ù†Ø¨Ø¹ Ø§Ù‚ØªØ¨Ø§Ø³:</strong> <span id="source-value">${offlineTranslator.translate(data.source) || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</span></p>
                    <p class="mb-2"><strong>ÙˆØ¶Ø¹ÛŒØª:</strong> <span id="status-value">${offlineTranslator.translate(data.status) || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</span></p>
                    <p class="mb-2"><strong>Ù‚Ø³Ù…Øªâ€ŒÙ‡Ø§:</strong> ${data.episodes || 'N/A'}</p>
                    <p class="mb-2"><strong>Ø±Ø¯Ù‡ Ø³Ù†ÛŒ:</strong> <span id="rating-value">${offlineTranslator.translate(data.rating) || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</span></p>
                    <p class="mb-2"><strong>Ø§Ø³ØªÙˆØ¯ÛŒÙˆ:</strong> ${studiosHTML}</p>
                    <p><strong>Ù¾Ø®Ø´:</strong> ${data.aired.from ? new Date(data.aired.from).toLocaleDateString('fa-IR') : 'Ù†Ø§Ù…Ø´Ø®Øµ'}</p>
                `;
            },
            async renderLatestEpisode(animeId) {
                const section = document.getElementById('latest-episode-section');
                if (!section) return;
                try {
                    const firstPageResult = await APIManager.fetchJikan(`anime/${animeId}/episodes`);
                    const lastPage = firstPageResult.pagination?.last_visible_page;
                    let lastEpisode = null;
                    if (lastPage && lastPage > 1) {
                        const lastPageResult = await APIManager.fetchJikan(`anime/${animeId}/episodes?page=${lastPage}`);
                        lastEpisode = lastPageResult.data?.reverse().find(ep => ep) || null;
                    } else if (firstPageResult.data?.length > 0) {
                        lastEpisode = firstPageResult.data[firstPageResult.data.length - 1];
                    }
                    if (lastEpisode && lastEpisode.aired) {
                        section.innerHTML = `
                            <div class="bg-accent-primary/10 border border-accent-primary/30 p-4 rounded-lg">
                                <h4 class="font-bold text-lg mb-2 accent-primary-text">Ø¢Ø®Ø±ÛŒÙ† Ù‚Ø³Ù…Øª Ù¾Ø®Ø´ Ø´Ø¯Ù‡</h4>
                                <p class="text-sm"><strong>Ù‚Ø³Ù…Øª ${lastEpisode.mal_id}:</strong> ${lastEpisode.title}</p>
                                <p class="text-xs text-secondary mt-1">ØªØ§Ø±ÛŒØ® Ù¾Ø®Ø´: ${new Date(lastEpisode.aired).toLocaleDateString('fa-IR')}</p>
                            </div>
                        `;
                    } else {
                        section.innerHTML = '';
                    }
                } catch (error) { 
                    console.error("Failed to fetch latest episode:", error); 
                    section.innerHTML = '';
                }
            },
            renderWatchOrderButton(data) {
                const watchOrderBtn = document.getElementById('watch-order-btn');
                if (!watchOrderBtn) return;
                const complexFranchises = ['monogatari', 'fate/', 'toaru', 'gundam', 'evangelion', 'suzumiya haruhi', 'a certain scientific', 'a certain magical'];
                const title = (data.title_english || data.title).toLowerCase();
                const isComplex = complexFranchises.some(franchise => title.includes(franchise));
                watchOrderBtn.classList.toggle('hidden', !isComplex);
            },
            async renderThemes(animeId) {
                const section = document.getElementById('tab-content-music');
                if (!section) return;
                section.innerHTML = `<h3 class="font-bold text-xl mb-4">Ù…ÙˆØ³ÛŒÙ‚ÛŒ Ù…ØªÙ†</h3><div class="loader mx-auto"></div>`;
                try {
                    const result = await APIManager.fetchJikan(`anime/${animeId}/themes`);
                    const { openings, endings } = result.data;
                    if (!openings?.length && !endings?.length) {
                        section.innerHTML = '';
                        return;
                    }
                    const createThemeHTML = (themes) => {
                        if (!themes || themes.length === 0) return '<li>Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</li>';
                        const cleanThemeForSearch = (theme) => {
                            if (!theme) return '';
                            return theme
                                .replace(/^#?\d*:\s*/, '')
                                .replace(/\s*\(eps.*\)$/, '')
                                .trim();
                        };
                        return themes.map(theme => {
                            const cleanQuery = cleanThemeForSearch(theme);
                            const escapedTheme = theme.replace(/"/g, '"');
                            const escapedQuery = cleanQuery.replace(/"/g, '"');
                            return `
                                <li class="flex justify-between items-center bg-tertiary p-3 rounded-lg">
                                    <span class="text-sm flex-1 truncate" title="${escapedTheme}">${theme}</span>
                                    <button data-action="search-youtube" data-query="${escapedQuery}" class="flex-shrink-0 text-xs bg-secondary hover:bg-primary text-accent-primary font-bold py-1 px-2 rounded transition-colors">
                                        Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø±
                                        <svg xmlns="http://www.w3.org/2000/svg" class="inline-block h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"></path></svg>
                                    </button>
                                </li>
                            `;
                        }).join('');
                    };
                    const openingsHTML = createThemeHTML(openings);
                    const endingsHTML = createThemeHTML(endings);
                    section.innerHTML = `
                        <h3 class="font-bold text-xl mb-4">Ù…ÙˆØ³ÛŒÙ‚ÛŒ Ù…ØªÙ†</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-bold text-lg mb-3 accent-primary-text">ØªÛŒØªØ±Ø§Ú˜Ù‡Ø§ÛŒ Ø¢ØºØ§Ø²ÛŒ (OP)</h4>
                                <ul class="space-y-2">${openingsHTML}</ul>
                            </div>
                            <div>
                                <h4 class="font-bold text-lg mb-3 accent-secondary-text">ØªÛŒØªØ±Ø§Ú˜Ù‡Ø§ÛŒ Ù¾Ø§ÛŒØ§Ù†ÛŒ (ED)</h4>
                                <ul class="space-y-2">${endingsHTML}</ul>
                            </div>
                        </div>`;
                } catch (error) {
                    console.error("Failed to fetch themes:", error);
                    section.innerHTML = `<h3 class="font-bold text-xl mb-4">Ù…ÙˆØ³ÛŒÙ‚ÛŒ Ù…ØªÙ†</h3><p class="text-secondary">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ÙˆØ³ÛŒÙ‚ÛŒ Ù…ØªÙ†.</p>`;
                }
            },
            renderSubtitlesSection(data) {
                const section = document.getElementById('subtitles-section');
                if (!section || !data.aired?.from) return;
                const airDate = new Date(data.aired.from);
                if (airDate.getFullYear() >= 2025) {
                    section.innerHTML = `
                        <h3 class="font-bold text-xl mb-4">Ø²ÛŒØ±Ù†ÙˆÛŒØ³</h3>
                        <div class="bg-tertiary p-4 rounded-lg">
                            <p class="text-secondary text-sm mb-4">Ø§Ú¯Ø± Ø¨Ø¯Ù†Ø¨Ø§Ù„ Ø²ÛŒØ±Ù†ÙˆÛŒØ³ Ø§Ù†ÛŒÙ…Ù‡ Ù‡Ø§ Ù‡Ø³ØªÛŒØ¯ Ø¨Ù‡ Ú©Ø§Ù†Ø§Ù„ ØªÙ„Ú¯Ø±Ø§Ù… Ù…Ù† Ø³Ø± Ø¨Ø²Ù†ÛŒØ¯.</p>
                            <button id="telegram-modal-btn" class="w-full text-center accent-primary-bg text-white font-bold py-3 px-6 rounded-lg hover:opacity-90 transition-opacity">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ú©Ø§Ù†Ø§Ù„ ØªÙ„Ú¯Ø±Ø§Ù…</button>
                        </div>
                    `;
                } else {
                     const searchUrl = `https://alsubs.site/?s=${encodeURIComponent(data.title)}`;
                     section.innerHTML = `
                        <h3 class="font-bold text-xl mb-4">Ø²ÛŒØ±Ù†ÙˆÛŒØ³</h3>
                        <div class="bg-tertiary p-4 rounded-lg">
                            <p class="text-secondary text-sm mb-4">Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø²ÛŒØ±Ù†ÙˆÛŒØ³ Ø§Ù†ÛŒÙ…Ù‡ Ù‡Ø§ Ø¨Ù‡ ÙˆØ¨ Ø³Ø§ÛŒØª Ø²ÛŒØ± Ø³Ø± Ø¨Ø²Ù†ÛŒØ¯.</p>
                            <a href="${searchUrl}" target="_blank" rel="noopener noreferrer" class="block w-full text-center accent-primary-bg text-white font-bold py-3 px-6 rounded-lg hover:opacity-90 transition-opacity">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ ÙˆØ¨ Ø³Ø§ÛŒØª alsubs</a>
                        </div>
                    `;
                }
            },
            
            // --- *** Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ø§Ø³Øª *** ---
            renderRelations(relations) {
                const section = document.getElementById('relations-section');
                if (!section || !relations || relations.length === 0) return;
                
                const relationsHTML = relations.map(rel => {
                    // Ø¨Ø®Ø´ Ø§Ù†ÛŒÙ…Ù‡â€ŒÙ‡Ø§ (Ù‚Ø§Ø¨Ù„ Ú©Ù„ÛŒÚ©)
                    const animeHTML = rel.entry.filter(entry => entry.type === 'anime').map(entry => `
                        <div class="result-card bg-tertiary p-3 rounded-lg flex items-center justify-between gap-4 cursor-pointer hover:bg-secondary/50 transition-colors border border-transparent" data-id="${entry.mal_id}">
                            <div>
                                <p class="font-bold text-sm">${entry.name}</p>
                                <p class="text-xs text-secondary">${rel.relation} (Ø§Ù†ÛŒÙ…Ù‡)</p>
                            </div>
                            <span class="text-lg">â†</span>
                        </div>
                    `).join('');
                    
                    // Ø¨Ø®Ø´ ØºÛŒØ± Ø§Ù†ÛŒÙ…Ù‡â€ŒÙ‡Ø§ (ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ú©Ù„ÛŒÚ© Ùˆ ØªØ±Ø¬Ù…Ù‡ Ø´Ø¯Ù‡)
                    const otherHTML = rel.entry.filter(entry => entry.type !== 'anime').map(entry => {
                        // ÙØ±Ù…Øª Ú©Ø±Ø¯Ù† Ù†ÙˆØ¹ (Ù…Ø«Ù„Ø§Ù‹ 'light_novel' Ø¨Ù‡ 'Light novel')
                        const formattedType = entry.type.replace(/_/g, ' ').replace(/\b\w/g, char => char.toUpperCase());
                        // ØªØ±Ø¬Ù…Ù‡ Ù†ÙˆØ¹
                        const translatedType = offlineTranslator.translate(formattedType);
                        
                        return `
                        <div class="bg-tertiary p-3 rounded-lg flex items-center justify-between gap-4 opacity-70 border border-transparent">
                            <div>
                                <p class="font-bold text-sm">${entry.name}</p>
                                <p class="text-xs text-secondary">${rel.relation} (${translatedType})</p>
                            </div>
                            <span class="text-lg text-secondary">â‡¥</span>
                        </div>
                        `;
                    }).join('');
                    
                    return animeHTML + otherHTML;
                }).join('');
                
                if (relationsHTML) {
                    section.innerHTML = `
                        <h3 class="font-bold text-xl mb-4">Ø§Ù†ÛŒÙ…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø±ØªØ¨Ø·</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            ${relationsHTML}
                        </div>
                    `;
                }
            },
            // --- *** Ù¾Ø§ÛŒØ§Ù† ØªØ§Ø¨Ø¹ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ *** ---

            async renderVideos(animeId, mainTrailer) {
                const section = document.getElementById('tab-content-trailers');
                if (!section) return;
                section.innerHTML = `<h3 class="font-bold text-xl mb-4">ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§</h3><div class="loader mx-auto"></div>`;
                try {
                    const result = await APIManager.fetchJikan(`anime/${animeId}/videos`);
                    const promos = result.data?.promo || [];
                    const allVideos = [];
                    if (mainTrailer?.embed_url) {
                        allVideos.push({
                            title: 'ØªØ±ÛŒÙ„Ø± Ø±Ø³Ù…ÛŒ',
                            embed_url: mainTrailer.embed_url
                        });
                    }
                    promos.forEach(promo => {
                        allVideos.push({
                            title: promo.title,
                            embed_url: promo.trailer.embed_url
                        });
                    });
                    if (allVideos.length === 0) {
                        section.innerHTML = '<h3 class="font-bold text-xl mb-4">ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§</h3><p class="text-secondary">ÙˆÛŒØ¯ÛŒÙˆÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>';
                        return;
                    }
                    let videosHTML = '';
                    allVideos.forEach(video => {
                        if (!video.embed_url) return;
                        const url = new URL(video.embed_url);
                        url.searchParams.set('autoplay', '0');
                        const finalEmbedUrl = url.toString();
                        videosHTML += `
                            <div class="mb-6">
                                <h4 class="font-bold text-lg mb-2 text-secondary">${video.title}</h4>
                                <div class="aspect-w-16 aspect-h-9 rounded-lg overflow-hidden shadow-lg border border-color">
                                    <iframe class="w-full h-full" src="${finalEmbedUrl}" frameborder="0" allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                </div>
                            </div>
                        `;
                    });
                    section.innerHTML = `
                        <h3 class="font-bold text-xl mb-4">ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§</h3>
                        <div class="space-y-6">${videosHTML}</div>
                    `;
                } catch (error) {
                    console.error("Failed to fetch videos:", error);
                    section.innerHTML = '<h3 class="font-bold text-xl mb-4">ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§</h3><p class="text-secondary">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§.</p>';
                }
            },
            async renderCharacters(animeId) {
                const charactersSection = document.getElementById('tab-content-characters');
                if (!charactersSection) return;
                charactersSection.innerHTML = `<div class="loader mx-auto"></div>`;
                try {
                    const result = await APIManager.fetchJikan(`anime/${animeId}/characters`);
                    if (currentAnimeData) {
                        currentAnimeData.fullCharacterList = result.data;
                    }
                    const allCharacters = result.data;
                    if (allCharacters.length === 0) {
                        charactersSection.innerHTML = '<p class="text-secondary">Ø´Ø®ØµÛŒØªÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>';
                        return;
                    }
                    charactersSection.innerHTML = `
                        <div id="character-cards-container" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            ${allCharacters.map(this.createCharacterCard).join('')}
                        </div>`;
                } catch (error) { 
                    charactersSection.innerHTML = '<p class="text-secondary">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø®ØµÛŒØªâ€ŒÙ‡Ø§.</p>';
                }
            },
            createCharacterCard(characterData) {
                const character = characterData.character;
                return `
                    <div class="bg-tertiary border border-color rounded-lg p-3 flex items-center gap-4 hover:border-accent-primary transition-colors">
                        <img src="${proxyImageUrl(character.images?.webp?.image_url)}" onerror="this.src='https://placehold.co/64x64/1A2233/939CB0?text=X'" class="w-16 h-16 rounded-full object-cover">
                        <div class="flex-grow">
                            <h4 class="font-bold">${character.name}</h4>
                            <p class="text-sm text-secondary">${characterData.role}</p>
                        </div>
                        <button data-action="chat" data-character-name="${character.name}" class="gemini-button text-white text-xs font-bold py-2 px-3 rounded-full">âœ¨ Ú†Øª</button>
                    </div>
                `;
            },
            async renderRecommendations(animeId) {
                const recSection = document.getElementById('recommendations-section');
                if (!recSection) return;
                try {
                    const result = await APIManager.fetchJikan(`anime/${animeId}/recommendations`);
                    const recommendations = result.data.slice(0, 6);
                    if(recommendations.length === 0) return;
                    recSection.innerHTML = `
                        <h3 class="font-bold text-xl mb-4">Ø§Ù†ÛŒÙ…Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            ${recommendations.map(rec => `
                                <div class="result-card bg-tertiary p-2 rounded-lg text-center cursor-pointer group border border-transparent" data-id="${rec.entry.mal_id}">
                                    <img src="${proxyImageUrl(rec.entry.images?.webp?.large_image_url)}" onerror="this.src='https://placehold.co/150x210/1A2233/939CB0?text=X'" class="w-full h-auto rounded-md mb-2">
                                    <p class="text-xs font-bold truncate group-hover:accent-primary-text transition-colors">${rec.entry.title}</p>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } catch (error) { console.error("Failed to fetch recommendations:", error); }
            },
            populateStudioModal(modal, studioName, animeData) {
                const modalContentHTML = `
                    <div class="p-4 border-b border-color flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <h3 class="text-2xl font-bold">${studioName}</h3>
                            <button id="analyze-studio-btn" class="gemini-button text-white text-sm font-bold py-2 px-4 rounded-full">âœ¨ ØªØ­Ù„ÛŒÙ„ Ø§Ø³ØªÙˆØ¯ÛŒÙˆ</button>
                        </div>
                        <button class="close-modal-btn p-2 text-2xl">Ã—</button>
                    </div>
                    <div class="p-6 overflow-y-auto max-h-[80vh]">
                        <div id="studio-analysis-container" class="mb-6"></div>
                        <div>
                            <h4 class="font-bold text-xl mb-4">Ø¢Ø«Ø§Ø± Ø¨Ø±Ø¬Ø³ØªÙ‡</h4>
                            <div id="studio-works-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                                ${animeData.map(anime => `
                                    <div class="result-card bg-tertiary p-2 rounded-lg text-center cursor-pointer group border border-transparent" data-id="${anime.mal_id}">
                                        <img src="${proxyImageUrl(anime.images?.webp?.large_image_url)}" onerror="this.src='https://placehold.co/150x210/1A2233/939CB0?text=X'" class="w-full h-auto rounded-md mb-2">
                                        <p class="text-xs font-bold truncate group-hover:accent-primary-text transition-colors">${anime.title}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                modal.innerHTML = modalContentHTML;
                const modalWrapper = modal.parentElement;
                if (modalWrapper) {
                    modalWrapper.studioName = studioName; 
                    modalWrapper.studioData = animeData;
                }
            }
        };

        const App = {
            
            getFriendlyErrorMessage(error) {
                const msg = error ? error.message.toLowerCase() : "";
                if (msg.includes('429') || msg.includes('resource exhausted') || msg.includes('rate limit')) {
                    return "Ø¸Ø±ÙÛŒØª API Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± ØªÚ©Ù…ÛŒÙ„ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ú†Ù†Ø¯ Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¯ÛŒÚ¯Ø± Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.";
                }
                if (msg.includes('prohibited_content')) {
                    return "Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ ØªÙˆØ³Ø· ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ø§ÛŒÙ…Ù†ÛŒ Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯ (Ù…Ø­ØªÙˆØ§ÛŒ Ù…Ù…Ù†ÙˆØ¹Ù‡).";
                }
                if (msg.includes('failed to fetch') || msg.includes('network')) {
                    return "Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø´Ø¨Ú©Ù‡. Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.";
                }
                // Ø§ÛŒÙ† Ù¾ÛŒØºØ§Ù… Ø³ÙØ§Ø±Ø´ÛŒ Ø§Ø² Ø¨Ú©â€ŒØ§Ù†Ø¯ Ù…ÛŒâ€ŒØ¢ÛŒØ¯
                if (msg.includes('translation failed')) {
                    return "ØªØ±Ø¬Ù…Ù‡ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯. (Ø®Ø·Ø§ÛŒ Ø¯Ø§Ø®Ù„ÛŒ Ø³Ø±ÙˆØ±)";
                }
                // Ø®Ø·Ø§ÛŒ Jikan (Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§)
                if (msg.includes('jikan api error') && (msg.includes('404') || msg.includes('500') || msg.includes('not found'))) {
                    return "Ù…ÙˆØ±Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÛŒØ§ÙØª Ù†Ø´Ø¯ (ØµÙØ­Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯).";
                }
                return `Ø®Ø·Ø§: ${error.message}`;
            },

            handlePathChange() {
                const path = window.location.pathname;
                const match = path.match(/\/anime\/(\d+)/);
                
                if (match && match[1]) {
                    const id = match[1];
                    UIManager.showDetailsPage(id);
                } else {
                    UIManager.showMainPage();
                    let tabName = 'search';
                    if (path === '/airing') {
                        tabName = 'airing';
                    } else if (path === '/top') {
                        tabName = 'top';
                    }
                    this.renderTabContent(tabName);
                }
            },

            renderTabContent(tabName) {
                currentListType = tabName;
                currentPage = 1;

                document.querySelectorAll('.tab-button').forEach(t => {
                    t.classList.remove('accent-primary-text');
                    t.classList.add('text-secondary');
                });
                const activeTab = document.querySelector(`.tab-button[data-tab="${tabName}"]`);
                if (activeTab) {
                    activeTab.classList.add('accent-primary-text');
                    activeTab.classList.remove('text-secondary');
                }
                
                DOMElements.searchPage.classList.toggle('hidden', tabName !== 'search');
                DOMElements.listPage.classList.toggle('hidden', tabName === 'search');
                
                DOMElements.resultsContainer.innerHTML = '';
                DOMElements.smartResultsTitle.classList.add('hidden');
                DOMElements.showMoreContainer.innerHTML = '';
                
                if (tabName === 'search') {
                    DOMElements.seasonNav.classList.add('hidden');
                    if (DOMElements.searchInput.value === '') {
                        UIManager.showMessage('Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ Ù†Ø§Ù… ÛŒÚ© Ø§Ù†ÛŒÙ…Ù‡ Ø±Ø§ Ø¬Ø³ØªØ¬Ùˆ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø§Ø² Ù…Ù†Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
                    }
                } else {
                    UIManager.showMessage('');
                    if (tabName === 'top') {
                        DOMElements.seasonNav.classList.add('hidden');
                        DOMElements.listTitle.textContent = 'Ø¨Ø±ØªØ±ÛŒÙ†â€ŒÙ‡Ø§ÛŒ MAL';
                        this.loadList(tabName, currentPage);
                    } else if (tabName === 'airing') {
                        DOMElements.seasonNav.classList.remove('hidden');
                        DOMElements.listTitle.textContent = 'Ø§Ù†ÛŒÙ…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø®Ø´';
                        this.loadList(tabName, currentPage);
                    }
                }
            },
            
            init() {
                this.setupEventListeners();
                this.applySavedTheme();
                this.initSeason();
                this.handlePathChange();
            },
            
            navigateToDetails(id) {
                const newPath = `/anime/${id}`;
                if (window.location.pathname !== newPath) {
                    history.pushState({ path: newPath }, null, newPath);
                }
                UIManager.showDetailsPage(id);
            },
            
            navigateBack() {
                history.back();
            },

            setupEventListeners() {
                
                window.addEventListener('popstate', (event) => {
                    this.handlePathChange();
                });

                DOMElements.searchForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleSearch(DOMElements.searchInput.value.trim());
                });
                DOMElements.searchInput.addEventListener('input', (e) => {
                    clearTimeout(searchDebounceTimeout);
                    const query = e.target.value.trim();
                    if (query.length > 2) {
                        searchDebounceTimeout = setTimeout(() => this.handleSearch(query), 600);
                    } else if (query.length === 0) {
                        DOMElements.resultsContainer.innerHTML = '';
                        DOMElements.smartResultsTitle.classList.add('hidden');
                        UIManager.showMessage('Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ Ù†Ø§Ù… ÛŒÚ© Ø§Ù†ÛŒÙ…Ù‡ Ø±Ø§ Ø¬Ø³ØªØ¬Ùˆ Ú©Ù†ÛŒØ¯.');
                    }
                });
                DOMElements.themeSwitch.addEventListener('change', () => {
                    const newTheme = DOMElements.themeSwitch.checked ? 'light' : 'dark';
                    localStorage.setItem('theme', newTheme);
                    this.applyTheme(newTheme);
                });

                document.body.addEventListener('click', (e) => {
                    const target = e.target;
                    
                    const tabNavButton = target.closest('.tab-nav-button');
                    if (tabNavButton) {
                        e.preventDefault();
                        const targetSelector = tabNavButton.dataset.tabTarget;
                        const targetContent = document.querySelector(targetSelector);
                        if (targetContent) {
                            document.querySelectorAll('.tab-nav-button').forEach(btn => btn.classList.remove('active'));
                            document.querySelectorAll('.tab-content').forEach(pane => pane.classList.add('hidden'));
                            tabNavButton.classList.add('active');
                            targetContent.classList.remove('hidden');
                        }
                        return;
                    }

                    const cardTarget = target.closest('.result-card[data-id]');
                    if (cardTarget) {
                        if (target.closest('#modal-container')) {
                            ModalManager.closeAll();
                        }
                        this.navigateToDetails(cardTarget.dataset.id);
                        return;
                    }
                    
                    const buttonTarget = target.closest('button');
                    if (buttonTarget) {
                        const action = buttonTarget.dataset.action;
                        const tab = buttonTarget.dataset.tab;

                        if (action === 'chat') { 
                            this.handleCharacterChat(buttonTarget.dataset.characterName);
                            return;
                        }
                        if (action === 'search-youtube') {
                            const query = buttonTarget.dataset.query;
                            window.open(`https://www.youtube.com/results?search_query=$${encodeURIComponent(query)}`, '_blank');
                            return;
                        }
                        if (tab) {
                            this.handleTabClick(buttonTarget);
                            return;
                        }

                        switch (buttonTarget.id) {
                            case 'smart-suggest-btn': this.handleSmartSuggest(); break;
                            case 'menu-toggle-btn': DOMElements.mainMenu.classList.toggle('hidden'); break;
                            case 'prev-season-btn': this.changeSeason(-1); break;
                            case 'next-season-btn': this.changeSeason(1); break;
                            case 'back-button': this.navigateBack(); break;
                            case 'smart-analysis-btn': this.handleSmartAnalysis(); break;
                            case 'find-similar-btn': this.handleFindSimilar(); break;
                            case 'watch-order-btn': this.handleWatchOrder(); break;
                            case 'telegram-modal-btn': this.handleTelegramInfoModal(); break;
                            case 'telegram-bot-btn': this.handleTelegramBotModal(); break;
                            case 'analyze-studio-btn':
                                const modal = document.getElementById('studio-modal');
                                if (modal && modal.studioName && modal.studioData) {
                                    this.handleStudioAnalysis(modal.studioName, modal.studioData);
                                }
                                break;
                            case 'show-more-btn':
                                currentPage++;
                                this.loadList(currentListType, currentPage, true);
                                break;
                            case 'force-refresh-btn':
                                if (currentAnimeData) {
                                    ModalManager.showNotification("Ø¯Ø± Ø­Ø§Ù„ ØªØ±Ø¬Ù…Ù‡ Ù…Ø¬Ø¯Ø¯...", "info");
                                    UIManager.showDetailsPage(currentAnimeData.mal_id, true);
                                }
                                break;
                        }
                    }

                    const linkTarget = target.closest('a[data-action="open-studio"]');
                    if (linkTarget) {
                        e.preventDefault();
                        this.handleStudioClick(linkTarget.dataset.studioId, linkTarget.dataset.studioName);
                        return;
                    }
                    
                    const closeModalButton = target.closest('.close-modal-btn');
                    if (closeModalButton) {
                        const modal = closeModalButton.closest('.fixed.inset-0');
                        if (modal) ModalManager.close(modal.id);
                        return;
                    }

                    if (!DOMElements.mainMenu.classList.contains('hidden') && !target.closest('#main-menu') && !target.closest('#menu-toggle-btn')) {
                        DOMElements.mainMenu.classList.add('hidden');
                    }
                });
            },
            async handleSearch(query) {
                if (!query) return;
                const isPersian = /[\u0600-\u06FF]/.test(query);
                if (isPersian) {
                    await this.handlePersianSearch(query);
                } else {
                    await this.handleStandardSearch(query);
                }
            },
            async handleStandardSearch(query) {
                latestSearchQuery = query;
                DOMElements.resultsContainer.innerHTML = '';
                DOMElements.smartResultsTitle.classList.add('hidden');
                UIManager.showMessage('');
                UIManager.showLoader(true);
                try {
                    const result = await APIManager.fetchJikan(`anime?q=${encodeURIComponent(query)}&limit=24`);
                    if (latestSearchQuery === query) {
                        UIManager.displayResults(result.data);
                    }
                } catch (error) { UIManager.showMessage(error.message, true);
                } finally { UIManager.showLoader(false); }
            },
            async handlePersianSearch(persianQuery) {
                latestSearchQuery = persianQuery;
                DOMElements.resultsContainer.innerHTML = '';
                DOMElements.smartResultsTitle.classList.add('hidden');
                UIManager.showMessage('');
                UIManager.showLoader(true);
                try {
                    const englishTitle = await APIManager.translateToEnglish(persianQuery);
                    const result = await APIManager.fetchJikan(`anime?q=${encodeURIComponent(englishTitle)}&limit=24`);
                    if (latestSearchQuery === persianQuery) {
                        UIManager.displayResults(result.data, `Ù†ØªØ§ÛŒØ¬ Ø¨Ø±Ø§ÛŒ Â«${persianQuery}Â»`);
                    }
                } catch (error) {
                    UIManager.showMessage(this.getFriendlyErrorMessage(error), true);
                } finally {
                    UIManager.showLoader(false);
                }
            },

            handleTabClick(tab) {
                const tabName = tab.dataset.tab;
                
                UIManager.showMainPage();

                let newPath = '/';
                if (tabName === 'airing') newPath = '/airing';
                else if (tabName === 'top') newPath = '/top';
                
                if (window.location.pathname !== newPath) {
                    history.pushState({ path: newPath }, null, newPath);
                }
                
                this.renderTabContent(tabName);
                DOMElements.mainMenu.classList.add('hidden');
            },

            async loadList(type, page, append = false) {
                UIManager.showLoader(true);
                if (!append) {
                    DOMElements.resultsContainer.innerHTML = '';
                }
                DOMElements.showMoreContainer.innerHTML = '';

                try {
                    let endpoint = '';
                    if (type === 'top') {
                        endpoint = `top/anime?page=${page}`;
                    } else if (type === 'airing') {
                        const { year, season } = currentSeasonState;
                        DOMElements.seasonDisplay.textContent = `${offlineTranslator.translate(season)} ${year}`;
                        endpoint = `seasons/${year}/${season}?page=${page}`;
                    }
                    
                    if(!endpoint) return;

                    const result = await APIManager.fetchJikan(endpoint);
                    UIManager.displayResults(result.data, null, { append, showMoreCallback: result.pagination.has_next_page });

                } catch (error) {
                    UIManager.showMessage(error.message, true);
                } finally {
                    UIManager.showLoader(false);
                }
            },
            initSeason() {
                const date = new Date();
                const year = date.getFullYear();
                const month = date.getMonth();
                let season = 'winter';
                if (month >= 2 && month <= 4) season = 'spring';
                if (month >= 5 && month <= 7) season = 'summer';
                if (month >= 8 && month <= 10) season = 'fall';
                currentSeasonState = { year, season };
            },
            changeSeason(direction) {
                const seasons = ['winter', 'spring', 'summer', 'fall'];
                let { year, season } = currentSeasonState;
                let seasonIndex = seasons.indexOf(season);
                seasonIndex += direction;
                if (seasonIndex > 3) { seasonIndex = 0; year++; } 
                else if (seasonIndex < 0) { seasonIndex = 3; year--; }
                currentSeasonState = { year, season: seasons[seasonIndex] };
                currentPage = 1;
                this.loadList('airing', currentPage);
            },
            applyTheme(theme) {
                document.body.classList.toggle('light', theme === 'light');
                DOMElements.themeSwitch.checked = theme === 'light';
            },
            applySavedTheme() {
                this.applyTheme(localStorage.getItem('theme') || 'dark');
            },
            
            async handleSmartSuggest() {
                const modalContent = `
                    <div class="p-4 border-b border-color flex justify-between items-center">
                        <h3 class="text-xl font-bold">âœ¨ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…ÙÙ‡ÙˆÙ…ÛŒ</h3>
                        <button class="close-modal-btn p-2 text-2xl">Ã—</button>
                    </div>
                    <div class="p-6">
                        <p class="text-secondary mb-4">ØªÙˆØ¶ÛŒØ­ Ø¯Ù‡ÛŒØ¯ Ø¯Ù†Ø¨Ø§Ù„ Ú†Ù‡ Ù†ÙˆØ¹ Ø§Ù†ÛŒÙ…Ù‡â€ŒØ§ÛŒ Ù‡Ø³ØªÛŒØ¯. Ù…Ø«Ù„Ø§: "ÛŒÚ© Ø§Ù†ÛŒÙ…Ù‡ Ù…Ø§Ø¬Ø±Ø§Ø¬ÙˆÛŒÛŒ Ø¨Ø§ Ø¯Ø§Ø³ØªØ§Ù†ÛŒ Ø­Ù…Ø§Ø³ÛŒ"</p>
                        <textarea id="smart-suggest-input" class="bg-tertiary w-full p-3 rounded-lg border-2 border-color focus:border-accent-primary focus:outline-none" rows="4"></textarea>
                        <button id="smart-suggest-submit" class="w-full mt-4 accent-primary-bg text-white font-bold py-3 px-6 rounded-lg">ÛŒØ§ÙØªÙ† Ø§Ù†ÛŒÙ…Ù‡â€ŒÙ‡Ø§</button>
                    </div>
                `;
                const modal = ModalManager.create('smart-suggest-modal', modalContent);
                
                modal.querySelector('#smart-suggest-submit').addEventListener('click', async () => {
                    const userInput = modal.querySelector('#smart-suggest-input').value.trim();
                    if (!userInput) return;
                    ModalManager.closeAll();
                    UIManager.showMessage('');
                    UIManager.showLoader(true);
                    try {
                        const prompt = `Based on the user's request in Persian: '${userInput}', recommend exactly 8 anime. Return a JSON object with a key "recommendations", an array of objects with keys "title" (English) and "mal_id" (the MyAnimeList ID as a number). Example: {"recommendations": [{"title": "Fullmetal Alchemist: Brotherhood", "mal_id": 5114}]}. Provide ONLY the JSON.`;
                        const response = await APIManager.callGemini(prompt, true);
                        if (!response.recommendations?.length) {
                            throw new Error("Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ù†ØªÙˆØ§Ù†Ø³Øª Ø§Ù†ÛŒÙ…Ù‡â€ŒØ§ÛŒ Ù…Ø·Ø§Ø¨Ù‚ Ø¨Ø§ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ù†Ø¯.");
                        }

                        const animeDataResults = [];
                        for (const rec of response.recommendations) {
                            try {
                                const res = await APIManager.fetchJikan(`anime/${rec.mal_id}`);
                                if (res.data) {
                                    animeDataResults.push({ node: res.data });
                                }
                            } catch (error) {
                                console.warn(`Could not fetch details for "${rec.title}":`, error);
                            }
                        }
                        
                        UIManager.displayResults(animeDataResults, `âœ¨ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ù‡Ø§ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø±Ø§ÛŒ: "${userInput}"`);
                    } catch (error) {
                        UIManager.showMessage(this.getFriendlyErrorMessage(error), true);
                    } finally {
                        UIManager.showLoader(false);
                    }
                });
            },
            handleTelegramInfoModal() {
                const modalContent = `
                    <div class="p-4 border-b border-color flex justify-between items-center">
                        <h3 class="text-xl font-bold">ğŸ“¢ ØªÙˆØ¬Ù‡</h3>
                        <button class="close-modal-btn p-2 text-2xl">Ã—</button>
                    </div>
                    <div class="p-6 text-center">
                        <p class="text-secondary mb-6">Ø§Ú¯Ø± Ø²ÛŒØ±Ù†ÙˆÛŒØ³ÛŒ Ø§Ø² Ø§Ù†ÛŒÙ…Ù‡ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø±ØªØ§Ù† Ù¾ÛŒØ¯Ø§ Ù†Ú©Ø±Ø¯ÛŒØ¯ Ø§Ø² Ø·Ø±ÙŠÙ‚ Ú¯Ø±ÙˆÙ‡ Ú†Øª Ø§Ø¹Ù„Ø§Ù… Ú©Ù†ÛŒØ¯ Ùˆ Ø¯Ø± Ú©ÙˆØªØ§Ù‡ ØªØ±ÛŒÙ† Ø²Ù…Ø§Ù† Ù…Ù…Ú©Ù† Ù‚Ø±Ø§Ø± Ø®ÙˆØ§Ù‡Ø¯ Ú¯Ø±ÙØª.</p>
                        <a href="https://t.me/anime_sub_Persian" target="_blank" rel="noopener noreferrer" class="block w-full text-center accent-primary-bg text-white font-bold py-3 px-6 rounded-lg hover:opacity-90 transition-opacity">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ú©Ø§Ù†Ø§Ù„ ØªÙ„Ú¯Ø±Ø§Ù…</a>
                    </div>
                `;
                ModalManager.create('telegram-info-modal', modalContent);
            },
            handleTelegramBotModal() {
                const modalContent = `
                    <div class="p-4 border-b border-color flex justify-between items-center">
                        <h3 class="text-xl font-bold">ğŸ¤– Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù… Aniran</h3>
                        <button class="close-modal-btn p-2 text-2xl">Ã—</button>
                    </div>
                    <div class="p-6 text-center">
                        <p class="text-secondary mb-6 leading-relaxed">Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù… Aniran Ø¨Ù‡ Ø´Ù…Ø§ Ø§ÛŒÙ† Ø§Ù…Ú©Ø§Ù† Ø±Ø§ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ú©Ù‡ Ø¨Ø§ Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³ Ø§Ø² Ù‡Ø± ØµØ­Ù†Ù‡ Ø§Ù†ÛŒÙ…Ù‡ØŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ù…Ù„ Ø¢Ù† Ø±Ø§ Ø¨Ù‡ Ù‡Ù…Ø±Ø§Ù‡ ÙˆÛŒØ¯ÛŒÙˆØŒ Ù„ÛŒØ³Øª Ø´Ø®ØµÛŒØªâ€ŒÙ‡Ø§ Ùˆ Ø§Ù†ÛŒÙ…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø´Ø§Ø¨Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†ÛŒØ¯. Ù‡Ù…Ú†Ù†ÛŒÙ† Ø¯Ø§Ø±Ø§ÛŒ Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…ØªÙ†ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø§Ø³Øª.</p>
                        <a href="https://t.me/AnimeChatAbolfazl_Bot" target="_blank" rel="noopener noreferrer" class="block w-full text-center accent-primary-bg text-white font-bold py-3 px-6 rounded-lg hover:opacity-90 transition-opacity">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù…</a>
                    </div>
                `;
                ModalManager.create('telegram-bot-info-modal', modalContent);
                DOMElements.mainMenu.classList.add('hidden');
            },
            async handleCharacterChat(characterName) {
                if (!currentAnimeData) return;
                const animeTitle = currentAnimeData.title_english || currentAnimeData.title;
                let chatHistory = [];
                const modal = ModalManager.create('character-chat-modal', `
                    <div class="p-4 border-b border-color flex justify-between items-center">
                        <h3 class="text-xl font-bold">âœ¨ Ú¯ÙØªÚ¯Ùˆ Ø¨Ø§ ${characterName}</h3>
                        <button class="close-modal-btn p-2 text-2xl">Ã—</button>
                    </div>
                    <div id="chat-messages" class="p-4 flex-grow overflow-y-auto h-96 flex flex-col gap-4">
                         <div class="chat-bubble chat-bubble-bot">Ø³Ù„Ø§Ù…! Ù…Ù† ${characterName} Ù‡Ø³ØªÙ…. Ú†Ù‡ Ø³ÙˆØ§Ù„ÛŒ Ø¯Ø§Ø±ÛŒØŸ</div>
                    </div>
                    <div class="p-4 border-t border-color">
                        <form id="chat-form" class="flex gap-2">
                            <input id="chat-input" type="text" class="bg-tertiary w-full p-3 rounded-lg border-2 border-color focus:border-accent-primary focus:outline-none" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯...">
                            <button type="submit" class="accent-primary-bg text-white font-bold py-3 px-5 rounded-lg">Ø§Ø±Ø³Ø§Ù„</button>
                        </form>
                    </div>`, {maxWidth: 'max-w-2xl'});
                
                modal.querySelector('#chat-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const chatInput = modal.querySelector('#chat-input');
                    const submitButton = e.target.querySelector('button');
                    const chatMessages = modal.querySelector('#chat-messages');
                    const userInput = chatInput.value.trim();
                    if (!userInput) return;

                    chatMessages.innerHTML += `<div class="chat-bubble chat-bubble-user">${userInput}</div>`;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    chatInput.value = '';
                    submitButton.disabled = true;
                    submitButton.textContent = '...';

                    chatHistory.push({ role: "user", parts: [{ text: userInput }] });
                    try {
                        const prompt = `You are roleplaying as ${characterName} from ${animeTitle}. Maintain this persona. Respond to the latest user message in character. IMPORTANT: Respond ONLY in Persian.\n\nConversation History:\n${JSON.stringify(chatHistory)}\n\nUser: "${userInput}"\n${characterName}:`;
                        const botResponse = await APIManager.callGemini(prompt);
                        chatHistory.push({ role: "model", parts: [{ text: botResponse }] });
                        chatMessages.innerHTML += `<div class="chat-bubble chat-bubble-bot">${botResponse}</div>`;
                    } catch (error) {
                        const friendlyError = this.getFriendlyErrorMessage(error);
                        chatMessages.innerHTML += `<div class="chat-bubble chat-bubble-bot text-red-400">${friendlyError}</div>`;
                    } finally {
                        submitButton.disabled = false;
                        submitButton.textContent = 'Ø§Ø±Ø³Ø§Ù„';
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                });
            },
            async handleSmartAnalysis() {
                if (!currentAnimeData) return;
                const modal = ModalManager.create('smart-analysis-modal', `
                    <div class="p-4 border-b border-color flex justify-between items-center">
                        <h3 class="text-xl font-bold">âœ¨ ØªØ­Ù„ÛŒÙ„ Ù‡ÙˆØ´Ù…Ù†Ø¯</h3>
                        <button class="close-modal-btn p-2 text-2xl">Ã—</button>
                    </div>
                    <div class="p-8 text-center"><div class="loader mx-auto"></div><p class="mt-4 text-secondary">Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„ Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ...</p></div>`, {maxWidth: 'max-w-3xl'});

                try {
                    const { title, synopsis, genres } = currentAnimeData;
                    const genreNames = genres.map(g => g.name).join(', ');
                    const prompt = `As an anime critic, provide a comprehensive analysis for '${title}' (genres: ${genreNames}, synopsis: ${synopsis}). Respond in Persian. Return a JSON object with keys: "analysis" (a brief summary), "strengths" (array of strings), "weaknesses" (array of strings), "audience" (a paragraph describing the ideal audience). Provide ONLY the JSON.`;
                    const analysis = await APIManager.callGemini(prompt, true);
                    modal.innerHTML = `
                        <div class="p-4 border-b border-color flex justify-between items-center">
                            <h3 class="text-xl font-bold">âœ¨ ØªØ­Ù„ÛŒÙ„ Ù‡ÙˆØ´Ù…Ù†Ø¯: ${title}</h3>
                            <button class="close-modal-btn p-2 text-2xl">Ã—</button>
                        </div>
                        <div class="p-6 overflow-y-auto max-h-[70vh] space-y-6">
                            <div>
                                <h4 class="font-bold text-lg accent-primary-text mb-2">ØªØ­Ù„ÛŒÙ„ Ú©Ù„ÛŒ</h4>
                                <p class="text-secondary leading-relaxed">${analysis.analysis}</p>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h4 class="font-bold text-lg text-green-400 mb-3">ğŸŸ¢ Ù†Ù‚Ø§Ø· Ù‚ÙˆØª Ø§Ø­ØªÙ…Ø§Ù„ÛŒ</h4>
                                    <ul class="list-disc list-inside text-secondary space-y-2">${analysis.strengths.map(s => `<li>${s}</li>`).join('')}</ul>
                                </div>
                                <div>
                                    <h4 class="font-bold text-lg text-red-400 mb-3">ğŸ”´ Ù†Ù‚Ø§Ø· Ø¶Ø¹Ù Ø§Ø­ØªÙ…Ø§Ù„ÛŒ</h4>
                                    <ul class="list-disc list-inside text-secondary space-y-2">${analysis.weaknesses.map(w => `<li>${w}</li>`).join('')}</ul>
                                </div>
                            </div>
                             <div>
                                <h4 class="font-bold text-lg accent-secondary-text mb-2">Ø¨Ø±Ø§ÛŒ Ú†Ù‡ Ú©Ø³Ø§Ù†ÛŒ Ù…Ù†Ø§Ø³Ø¨ Ø§Ø³ØªØŸ</h4>
                                <p class="text-secondary leading-relaxed">${analysis.audience}</p>
                            </div>
                        </div>`;
                } catch (error) {
                    const friendlyError = this.getFriendlyErrorMessage(error);
                    modal.querySelector('.p-8').innerHTML = `<p class="p-4 text-center text-red-400">${friendlyError}</p>`;
                }
            },
            async handleFindSimilar() {
                if (!currentAnimeData) return;
                const modal = ModalManager.create('similar-anime-modal', `
                    <div class="p-4 border-b border-color flex justify-between items-center">
                        <h3 class="text-xl font-bold">âœ¨ ÛŒØ§ÙØªÙ† Ø§Ù†ÛŒÙ…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø´Ø§Ø¨Ù‡</h3>
                        <button class="close-modal-btn p-2 text-2xl">Ã—</button>
                    </div>
                    <div class="p-8 text-center"><div class="loader mx-auto"></div><p class="mt-4 text-secondary">Ø¯Ø± Ø­Ø§Ù„ ÛŒØ§ÙØªÙ† Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ù‡Ø§...</p></div>`, {maxWidth: 'max-w-4xl'});

                try {
                    const { title, genres, synopsis } = currentAnimeData;
                    const prompt = `Based on the anime "${title}" (genres: ${genres.map(g=>g.name).join(', ')}, synopsis: ${synopsis}), recommend 4 similar anime. For each, provide a brief reason. The reason MUST be in Persian. Return a JSON object with a key "recommendations", an array of objects with keys "title" (English) and "reason" (the reason in Persian). Example: {"recommendations": [{"title": "Attack on Titan", "reason": "ÙØ¶Ø§ÛŒÛŒ ØªØ§Ø±ÛŒÚ© Ùˆ Ù†Ø¨Ø±Ø¯Ù‡Ø§ÛŒ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒÚ© Ø¯Ø§Ø±Ø¯."}]}`;
                    const response = await APIManager.callGemini(prompt, true);
                    if (!response.recommendations?.length) throw new Error("Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ù†ØªÙˆØ§Ù†Ø³Øª Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…Ø´Ø§Ø¨Ù‡ÛŒ Ù¾ÛŒØ¯Ø§ Ú©Ù†Ø¯.");

                    let resultsHTML = '';
                    for (const rec of response.recommendations) {
                        try {
                            const res = await APIManager.fetchJikan(`anime?q=${encodeURIComponent(rec.title)}&limit=1`);
                            const animeInfo = res.data?.[0];
                            if (animeInfo) {
                                resultsHTML += `
                                    <div class="result-card bg-tertiary border border-color rounded-lg p-4 flex items-start gap-4 cursor-pointer hover:bg-secondary transition-colors" data-id="${animeInfo.mal_id}">
                                        <img src="${proxyImageUrl(animeInfo.images.webp.image_url)}" class="w-20 h-auto rounded-md flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/80x113/1A2233/939CB0?text=X';">
                                        <div class="flex-grow">
                                            <h4 class="font-bold text-lg">${animeInfo.title}</h4>
                                            <p class="text-sm text-secondary mt-1">${rec.reason}</p>
                                        </div>
                                    </div>`;
                            }
                        } catch(e){ console.warn(`Could not fetch data for similar anime: ${rec.title}`, e); }
                    }
                    modal.innerHTML = `
                        <div class="p-4 border-b border-color flex justify-between items-center">
                            <h3 class="text-xl font-bold">âœ¨ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ù‡Ø§ÛŒ Ù…Ø´Ø§Ø¨Ù‡ Ø¨Ø±Ø§ÛŒ ${title}</h3>
                            <button class="close-modal-btn p-2 text-2xl">Ã—</button>
                        </div>
                        <div id="similar-results-container" class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4 overflow-y-auto max-h-[70vh]">${resultsHTML}</div>`;
                } catch (error) {
                    const friendlyError = this.getFriendlyErrorMessage(error);
                    modal.querySelector('.p-8').innerHTML = `<p class="p-4 text-center text-red-400">${friendlyError}</p>`;
                }
            },
            async handleStudioClick(studioId, studioName) {
                const modal = ModalManager.create('studio-modal', `
                    <div class="p-4 border-b border-color flex justify-between items-center">
                        <h3 class="text-xl font-bold">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø³ØªÙˆØ¯ÛŒÙˆ</h3>
                        <button class="close-modal-btn p-2 text-2xl">Ã—</button>
                    </div>
                    <div class="p-8 text-center"><div class="loader mx-auto"></div><p class="mt-4 text-secondary">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø«Ø§Ø± Ø§Ø³ØªÙˆØ¯ÛŒÙˆ ${studioName}...</p></div>
                `, { maxWidth: 'max-w-4xl' });

                try {
                    let allAnime = [];
                    let page = 1;
                    let hasNextPage = true;

                    while(hasNextPage) {
                        console.log(`Fetching studio works page ${page}...`);
                        const result = await APIManager.fetchJikan(`anime?producers=${studioId}&page=${page}`);
                        if (result.data && result.data.length > 0) {
                            allAnime.push(...result.data);
                        }
                        hasNextPage = result.pagination?.has_next_page || false;
                        page++;
                        await delay(350);
                    }
                    
                    const sortedData = allAnime.sort((a, b) => (b.members || 0) - (a.members || 0));
                    
                    UIManager.populateStudioModal(modal, studioName, sortedData);

                } catch (error) {
                    ModalManager.close('studio-modal');
                    UIManager.showMessage(`Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø³ØªÙˆØ¯ÛŒÙˆ: ${error.message}`, true);
                }
            },
            async handleStudioAnalysis(studioName, animeData) {
                const analysisContainer = document.getElementById('studio-analysis-container');
                if (!analysisContainer) return;

                analysisContainer.innerHTML = `<div class="p-4 text-center"><div class="loader mx-auto"></div><p class="mt-4 text-secondary">Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„ Ø§Ø³ØªÙˆØ¯ÛŒÙˆ ${studioName}...</p></div>`;
                const analyzeBtn = document.getElementById('analyze-studio-btn');
                if(analyzeBtn) analyzeBtn.disabled = true;

                try {
                    const animeTitles = animeData.slice(0, 15).map(a => a.title).join(', ');
                    const prompt = `Provide a brief analysis of the animation studio "${studioName}". Comment on their typical genres, animation style, and reputation based on these works: ${animeTitles}. Your entire response, including the JSON values, MUST be in Persian. Ensure all genre names in the "common_genres" array are the Persian translations. Return a JSON object with keys: "analysis" (a paragraph in Persian), "common_genres" (array of Persian genre names), and "key_strengths" (array of strings in Persian). Provide ONLY the JSON.`;
                    
                    const analysis = await APIManager.callGemini(prompt, true);
                    
                    const translatedGenres = (analysis.common_genres || []).map(g => offlineTranslator.translate(g));

                    analysisContainer.innerHTML = `
                        <h4 class="font-bold text-xl mb-3 accent-primary-text">ØªØ­Ù„ÛŒÙ„ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø§Ø³ØªÙˆØ¯ÛŒÙˆ</h4>
                        <p class="text-secondary leading-relaxed mb-4">${analysis.analysis || ''}</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h5 class="font-bold text-lg mb-2">Ú˜Ø§Ù†Ø±Ù‡Ø§ÛŒ Ù…ØªØ¯Ø§ÙˆÙ„</h5>
                                <div class="flex flex-wrap gap-2">
                                    ${translatedGenres.map(g => `<span class="bg-tertiary text-sm font-semibold px-3 py-1 rounded-full">${g}</span>`).join('')}
                                </div>
                            </div>
                            <div>
                                <h5 class="font-bold text-lg mb-2">Ù†Ù‚Ø§Ø· Ù‚ÙˆØª Ú©Ù„ÛŒØ¯ÛŒ</h5>
                                <ul class="list-disc list-inside text-secondary space-y-1">
                                    ${(analysis.key_strengths || []).map(s => `<li>${s}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    const friendlyError = this.getFriendlyErrorMessage(error);
                    analysisContainer.innerHTML = `<p class="p-4 text-center text-red-400">${friendlyError}</p>`;
                    if(analyzeBtn) analyzeBtn.disabled = false;
                }
            },
            async handleWatchOrder() {
                if (!currentAnimeData) return;
                const title = currentAnimeData.title_english || currentAnimeData.title;
                const modal = ModalManager.create('watch-order-modal', `
                    <div class="p-4 border-b border-color flex justify-between items-center">
                        <h3 class="text-xl font-bold">ğŸ“œ ØªØ±ØªÛŒØ¨ ØªÙ…Ø§Ø´Ø§ÛŒ ${title}</h3>
                        <button class="close-modal-btn p-2 text-2xl">Ã—</button>
                    </div>
                    <div class="p-8 text-center"><div class="loader mx-auto"></div><p class="mt-4 text-secondary">Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯ ØªØ±ØªÛŒØ¨ ØªÙ…Ø§Ø´Ø§ Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ...</p></div>`, {maxWidth: 'max-w-3xl'});

                try {
                    const prompt = `Generate the recommended watch order for the "${title}" anime franchise. Provide a detailed, step-by-step list. Your response MUST be in Persian. Return a JSON object with a key "watchOrder", which is an array of objects. Each object MUST have "title" (the anime title), "mal_id" (the MyAnimeList ID as a number), "type" (e.g., "Ø³Ø±ÛŒØ§Ù„ ØªÙ„ÙˆÛŒØ²ÛŒÙˆÙ†ÛŒ", "ÙÛŒÙ„Ù… Ø³ÛŒÙ†MØ§ÛŒÛŒ"), and "note" (a brief explanation in Persian for why it's in this position). Provide ONLY the JSON.`;
                    const result = await APIManager.callGemini(prompt, true);
                    
                    if (!result.watchOrder || result.watchOrder.length === 0) {
                        throw new Error("Ù¾Ø§Ø³Ø® Ù…Ø¹ØªØ¨Ø±ÛŒ Ø§Ø² Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯.");
                    }

                    const orderHTML = result.watchOrder.map((item, index) => `
                        <li class="result-card p-4 bg-tertiary rounded-lg border border-color transition-colors hover:border-accent-primary" data-id="${item.mal_id || 0}" style="cursor: pointer;">
                            <div class="flex items-start gap-4">
                                <span class="flex-shrink-0 text-2xl font-bold accent-primary-text">${index + 1}</span>
                                <div>
                                    <h4 class="font-bold text-lg">${item.title} <span class="text-xs font-normal bg-secondary px-2 py-1 rounded-full">${item.type}</span></h4>
                                    <p class="text-sm text-secondary mt-1">${item.note}</p>
                                </div>
                            </div>
                        </li>
                    `).join('');

                    modal.innerHTML = `
                        <div class="p-4 border-b border-color flex justify-between items-center">
                            <h3 class="text-xl font-bold">ğŸ“œ ØªØ±ØªÛŒØ¨ ØªÙ…Ø§Ø´Ø§ÛŒ ${title}</h3>
                            <button class="close-modal-btn p-2 text-2xl">Ã—</button>
                        </div>
                        <div class="p-6 overflow-y-auto max-h-[70vh]">
                            <ol class="space-y-4">${orderHTML}</ol>
                        </div>`;

                } catch (error) {
                    const friendlyError = this.getFriendlyErrorMessage(error);
                    modal.querySelector('.p-8').innerHTML = `<p class="p-4 text-center text-red-400">${friendlyError}</p>`;
                }
            }
        };

        window.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
